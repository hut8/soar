#!/bin/bash
# SOAR Server Provisioning Script
#
# This script provisions a server for SOAR by installing systemd services,
# setting up deployment privileges, and configuring the environment.
#
# Usage:
#   sudo ./provision <staging|production>
#
# Arguments:
#   staging     - Provision for staging environment (soar_staging database, staging.glider.flights)
#   production  - Provision for production environment (soar database, glider.flights)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check for required argument
if [ $# -ne 1 ]; then
    echo -e "${RED}Error: Environment argument required${NC}"
    echo "Usage: $0 <staging|production>"
    echo ""
    echo "Arguments:"
    echo "  staging     - Provision for staging environment (soar_staging database)"
    echo "  production  - Provision for production environment (soar database)"
    exit 1
fi

ENVIRONMENT="$1"

# Validate environment argument
if [[ "$ENVIRONMENT" != "staging" ]] && [[ "$ENVIRONMENT" != "production" ]]; then
    echo -e "${RED}Error: Invalid environment '$ENVIRONMENT'${NC}"
    echo "Must be either 'staging' or 'production'"
    exit 1
fi

# Set environment-specific variables
if [[ "$ENVIRONMENT" == "production" ]]; then
    DB_NAME="soar"
    ENV_FILE="/etc/soar/env"
    WEB_PORT="61225"
    DOMAIN="glider.flights"
    # Caddy site configs to install for production
    CADDY_SITES=("glider.flights" "pelias.glider.flights" "grafana.glider.flights")
else
    DB_NAME="soar_staging"
    ENV_FILE="/etc/soar/env-staging"
    WEB_PORT="61226"
    DOMAIN="staging.glider.flights"
    # Caddy site configs to install for staging
    CADDY_SITES=("staging.glider.flights" "pelias.staging.glider.flights" "grafana.staging.glider.flights")
fi

echo -e "${GREEN}Provisioning SOAR server for ${ENVIRONMENT} environment...${NC}"
echo -e "${BLUE}Database: $DB_NAME${NC}"
echo -e "${BLUE}Environment file: $ENV_FILE${NC}"
echo -e "${BLUE}Web port: $WEB_PORT${NC}"
echo -e "${BLUE}Domain: $DOMAIN${NC}"
echo ""

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root (use sudo)${NC}"
   exit 1
fi

# Detect OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    OS_VERSION=$VERSION_ID
else
    echo -e "${RED}Error: Cannot detect OS. /etc/os-release not found.${NC}"
    exit 1
fi

echo -e "${BLUE}Detected OS: $OS $OS_VERSION${NC}"

# Check if OS is Debian or Ubuntu - EXIT IMMEDIATELY IF NOT
if [[ "$OS" != "ubuntu" ]] && [[ "$OS" != "debian" ]]; then
    echo -e "${RED}Error: This script only supports Debian and Ubuntu.${NC}"
    echo -e "${RED}Detected OS: $OS${NC}"
    echo -e "${YELLOW}Please run this script on a Debian or Ubuntu system.${NC}"
    exit 1
fi

# ============================================================================
# APT Repository Setup
# ============================================================================
# Install all APT repositories first, then run apt-get update once
# This is more efficient than updating after each repo addition

echo -e "${BLUE}Setting up APT repositories...${NC}"

# Install prerequisites for adding repositories
sudo apt-get update
sudo apt-get install -y wget ca-certificates lsb-release gnupg curl

# Create keyrings directories
sudo mkdir -p /etc/apt/keyrings
sudo mkdir -p /usr/share/keyrings

REPOS_ADDED=false

# PostgreSQL repository
if [ ! -f /etc/apt/sources.list.d/pgdg.list ]; then
    echo -e "${BLUE}Adding PostgreSQL APT repository...${NC}"
    if [ ! -f /etc/apt/keyrings/postgresql.gpg ]; then
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | \
            sudo gpg --dearmor -o /etc/apt/keyrings/postgresql.gpg
    fi
    echo "deb [signed-by=/etc/apt/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | \
        sudo tee /etc/apt/sources.list.d/pgdg.list
    REPOS_ADDED=true
else
    echo -e "${BLUE}PostgreSQL repository already configured${NC}"
fi

# TimescaleDB repository
if [ ! -f /etc/apt/sources.list.d/timescaledb.list ]; then
    echo -e "${BLUE}Adding TimescaleDB APT repository...${NC}"
    if [ ! -f /usr/share/keyrings/timescaledb.gpg ]; then
        curl -fsSL https://packagecloud.io/timescale/timescaledb/gpgkey | \
            sudo gpg --dearmor -o /usr/share/keyrings/timescaledb.gpg
    fi
    echo "deb [signed-by=/usr/share/keyrings/timescaledb.gpg] https://packagecloud.io/timescale/timescaledb/debian/ $(lsb_release -cs) main" | \
        sudo tee /etc/apt/sources.list.d/timescaledb.list
    REPOS_ADDED=true
else
    echo -e "${BLUE}TimescaleDB repository already configured${NC}"
fi

# Grafana repository (includes Grafana, Pyroscope, Alloy, Loki, Tempo)
if [ ! -f /etc/apt/sources.list.d/grafana.list ]; then
    echo -e "${BLUE}Adding Grafana APT repository...${NC}"
    if [ ! -f /etc/apt/keyrings/grafana.gpg ]; then
        wget -q -O - https://apt.grafana.com/gpg.key | \
            sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
    fi
    echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | \
        sudo tee /etc/apt/sources.list.d/grafana.list
    REPOS_ADDED=true
else
    echo -e "${BLUE}Grafana repository already configured${NC}"
fi

# Caddy repository
if [ ! -f /etc/apt/sources.list.d/caddy-stable.list ]; then
    echo -e "${BLUE}Adding Caddy APT repository...${NC}"
    if [ ! -f /usr/share/keyrings/caddy-stable-archive-keyring.gpg ]; then
        curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | \
            sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
    fi
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | \
        sudo tee /etc/apt/sources.list.d/caddy-stable.list
    REPOS_ADDED=true
else
    echo -e "${BLUE}Caddy repository already configured${NC}"
fi

# GitHub CLI repository
if [ ! -f /etc/apt/sources.list.d/github-cli.list ]; then
    echo -e "${BLUE}Adding GitHub CLI APT repository...${NC}"
    if [ ! -f /etc/apt/keyrings/githubcli-archive-keyring.gpg ]; then
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
            sudo gpg --dearmor -o /etc/apt/keyrings/githubcli-archive-keyring.gpg
    fi
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
        sudo tee /etc/apt/sources.list.d/github-cli.list
    REPOS_ADDED=true
else
    echo -e "${BLUE}GitHub CLI repository already configured${NC}"
fi

# Run apt-get update once if any repos were added
if [ "$REPOS_ADDED" = true ]; then
    echo -e "${BLUE}Updating package lists after adding repositories...${NC}"
    sudo apt-get update
fi

echo -e "${GREEN}APT repositories configured${NC}"

# ============================================================================
# Package Installation
# ============================================================================

# Install PostgreSQL 18
echo -e "${BLUE}Installing PostgreSQL 18...${NC}"
sudo apt-get install -y postgresql-18 postgresql-client-18 postgresql-18-postgis-3 postgresql-18-partman uuid-runtime

echo -e "${GREEN}PostgreSQL 18 installed successfully${NC}"

# Install TimescaleDB
echo -e "${BLUE}Installing TimescaleDB...${NC}"
sudo apt-get install -y timescaledb-toolkit-postgresql-18 timescaledb-tools timescaledb-2-postgresql-18

echo -e "${GREEN}TimescaleDB installed successfully${NC}"

# Configure PostgreSQL to load TimescaleDB
echo -e "${BLUE}Configuring PostgreSQL to load TimescaleDB...${NC}"

POSTGRESQL_CONF="/etc/postgresql/18/main/postgresql.conf"
TIMESCALEDB_CONFIG_CHANGED=false

# Backup postgresql.conf
sudo cp "$POSTGRESQL_CONF" "$POSTGRESQL_CONF.backup.$(date +%Y%m%d_%H%M%S)"

# Check if shared_preload_libraries already includes timescaledb
if grep -q "^shared_preload_libraries.*timescaledb" "$POSTGRESQL_CONF"; then
    echo -e "${BLUE}TimescaleDB already configured in shared_preload_libraries${NC}"
elif grep -q "^#shared_preload_libraries" "$POSTGRESQL_CONF"; then
    # Uncomment and set to timescaledb
    sudo sed -i "s/^#shared_preload_libraries.*/shared_preload_libraries = 'timescaledb'/" "$POSTGRESQL_CONF"
    echo -e "${GREEN}Enabled and set shared_preload_libraries = 'timescaledb'${NC}"
    TIMESCALEDB_CONFIG_CHANGED=true
elif grep -q "^shared_preload_libraries" "$POSTGRESQL_CONF"; then
    # Append timescaledb to existing value
    sudo sed -i "s/^shared_preload_libraries = '\(.*\)'/shared_preload_libraries = '\1,timescaledb'/" "$POSTGRESQL_CONF"
    echo -e "${GREEN}Added timescaledb to existing shared_preload_libraries${NC}"
    TIMESCALEDB_CONFIG_CHANGED=true
else
    # Add new line
    echo "shared_preload_libraries = 'timescaledb'" | sudo tee -a "$POSTGRESQL_CONF" > /dev/null
    echo -e "${GREEN}Added shared_preload_libraries = 'timescaledb' to postgresql.conf${NC}"
    TIMESCALEDB_CONFIG_CHANGED=true
fi

# Ensure PostgreSQL is enabled
sudo systemctl enable postgresql

# Only restart if we changed the configuration
if [ "$TIMESCALEDB_CONFIG_CHANGED" = true ]; then
    echo -e "${BLUE}Restarting PostgreSQL to load TimescaleDB...${NC}"
    sudo systemctl restart postgresql
    echo -e "${GREEN}PostgreSQL service restarted with TimescaleDB enabled${NC}"
else
    # Just ensure it's running
    if ! systemctl is-active --quiet postgresql; then
        sudo systemctl start postgresql
        echo -e "${GREEN}PostgreSQL service started${NC}"
    else
        echo -e "${BLUE}PostgreSQL is already running${NC}"
    fi
fi

# Create soar user if it doesn't exist
if ! id "soar" &>/dev/null; then
    echo -e "${BLUE}Creating 'soar' system user...${NC}"
    sudo useradd --system --user-group --create-home --home-dir /home/soar --shell /bin/bash soar
    echo -e "${GREEN}'soar' user created successfully${NC}"
else
    echo -e "${BLUE}'soar' user already exists${NC}"
fi

# Create pyroscope user if it doesn't exist
if ! id "pyroscope" &>/dev/null; then
    echo -e "${BLUE}Creating 'pyroscope' system user...${NC}"
    sudo useradd --system --home-dir /var/lib/pyroscope --shell /bin/false pyroscope
    echo -e "${GREEN}'pyroscope' user created successfully${NC}"
else
    echo -e "${BLUE}'pyroscope' user already exists${NC}"
fi

# Create alloy user if it doesn't exist
if ! id "alloy" &>/dev/null; then
    echo -e "${BLUE}Creating 'alloy' system user...${NC}"
    sudo useradd --system --home-dir /var/lib/alloy --shell /bin/false alloy
    echo -e "${GREEN}'alloy' user created successfully${NC}"
else
    echo -e "${BLUE}'alloy' user already exists${NC}"
fi

# Create loki user if it doesn't exist
if ! id "loki" &>/dev/null; then
    echo -e "${BLUE}Creating 'loki' system user...${NC}"
    sudo useradd --system --home-dir /var/lib/loki --shell /bin/false loki
    echo -e "${GREEN}'loki' user created successfully${NC}"
else
    echo -e "${BLUE}'loki' user already exists${NC}"
fi

# Create tempo user if it doesn't exist
if ! id "tempo" &>/dev/null; then
    echo -e "${BLUE}Creating 'tempo' system user...${NC}"
    sudo useradd --system --home-dir /var/lib/tempo --shell /bin/false tempo
    echo -e "${GREEN}'tempo' user created successfully${NC}"
else
    echo -e "${BLUE}'tempo' user already exists${NC}"
fi

# Install sudoers configuration for deployment
echo -e "${BLUE}Installing deployment sudoers configuration...${NC}"
sudo cp infrastructure/sudoers.d/soar /etc/sudoers.d/
sudo chmod 440 /etc/sudoers.d/soar

# Validate sudoers syntax
echo "Validating sudoers configuration..."
if ! sudo visudo -c -f /etc/sudoers.d/soar; then
    echo -e "${RED}Error: Invalid sudoers syntax. Removing file.${NC}"
    sudo rm -f /etc/sudoers.d/soar
    exit 1
fi

# Install NATS server binary if not already installed
if [ ! -f /usr/local/bin/nats-server ]; then
    echo -e "${BLUE}Installing NATS server binary...${NC}"
    NATS_VERSION="2.10.24"
    NATS_URL="https://github.com/nats-io/nats-server/releases/download/v${NATS_VERSION}/nats-server-v${NATS_VERSION}-linux-amd64.tar.gz"

    (
        cd /tmp
        wget -q "$NATS_URL" || { echo -e "${RED}Failed to download nats-server${NC}"; exit 1; }
        tar -xzf "nats-server-v${NATS_VERSION}-linux-amd64.tar.gz"
        sudo install -m 755 "nats-server-v${NATS_VERSION}-linux-amd64/nats-server" /usr/local/bin/
        rm -rf "nats-server-v${NATS_VERSION}-linux-amd64.tar.gz" "nats-server-v${NATS_VERSION}-linux-amd64"
    )
    echo -e "${GREEN}NATS server installed successfully${NC}"
else
    echo -e "${BLUE}NATS server already installed${NC}"
fi

# Install Prometheus
echo -e "${BLUE}Installing Prometheus...${NC}"
sudo apt-get install -y prometheus
echo -e "${GREEN}Prometheus installed successfully${NC}"

# Install Grafana
echo -e "${BLUE}Installing Grafana...${NC}"
sudo apt-get install -y grafana

echo -e "${GREEN}Grafana installed successfully${NC}"

# Install Pyroscope
echo -e "${BLUE}Installing Pyroscope...${NC}"

# Pyroscope is in the same Grafana repository
sudo apt-get install -y pyroscope

echo -e "${GREEN}Pyroscope installed successfully${NC}"

# Install Alloy
echo -e "${BLUE}Installing Grafana Alloy...${NC}"

# Alloy is also in the Grafana repository
sudo apt-get install -y alloy

echo -e "${GREEN}Grafana Alloy installed successfully${NC}"

# Install Loki
echo -e "${BLUE}Installing Grafana Loki...${NC}"

# Loki is also in the Grafana repository
sudo apt-get install -y loki

echo -e "${GREEN}Grafana Loki installed successfully${NC}"

# Install Tempo
echo -e "${BLUE}Installing Grafana Tempo...${NC}"

# Tempo is also in the Grafana repository
sudo apt-get install -y tempo

echo -e "${GREEN}Grafana Tempo installed successfully${NC}"

# Install Caddy
echo -e "${BLUE}Installing Caddy web server...${NC}"
sudo apt-get install -y caddy

echo -e "${GREEN}Caddy installed successfully${NC}"

# Install GitHub CLI
echo -e "${BLUE}Installing GitHub CLI...${NC}"
sudo apt-get install -y gh
echo -e "${GREEN}GitHub CLI installed successfully${NC}"

# Install prometheus-nats-exporter binary if not already installed
if [ ! -f /usr/local/bin/prometheus-nats-exporter ]; then
    echo -e "${BLUE}Installing prometheus-nats-exporter binary...${NC}"
    EXPORTER_VERSION="0.17.3"
    EXPORTER_URL="https://github.com/nats-io/prometheus-nats-exporter/releases/download/v${EXPORTER_VERSION}/prometheus-nats-exporter-v${EXPORTER_VERSION}-linux-x86_64.tar.gz"

    (
        cd /tmp
        wget -q "$EXPORTER_URL" || { echo -e "${RED}Failed to download prometheus-nats-exporter${NC}"; exit 1; }
        tar -xzf "prometheus-nats-exporter-v${EXPORTER_VERSION}-linux-x86_64.tar.gz"
        sudo install -m 755 prometheus-nats-exporter /usr/local/bin/
        rm -f "prometheus-nats-exporter-v${EXPORTER_VERSION}-linux-x86_64.tar.gz" prometheus-nats-exporter
    )
    echo -e "${GREEN}prometheus-nats-exporter installed successfully${NC}"
else
    echo -e "${BLUE}prometheus-nats-exporter already installed${NC}"
fi

# Copy infrastructure service files
# Note: SOAR application service files (soar-run, soar-web, etc.) are installed by soar-deploy
# Note: Pyroscope and Alloy service files are provided by their packages, not installed here
echo -e "${BLUE}Installing infrastructure systemd service files...${NC}"
sudo cp infrastructure/nats-server.service /etc/systemd/system/
sudo cp infrastructure/prometheus-nats-exporter.service /etc/systemd/system/

# Install migration service (templated for staging/production)
echo -e "${BLUE}Installing migration service...${NC}"
sudo cp infrastructure/systemd/soar-migrate@.service /etc/systemd/system/

# Create migration log directory
echo -e "${BLUE}Creating migration log directory...${NC}"
sudo mkdir -p /var/lib/soar/logs/migrations
sudo chown -R soar:soar /var/lib/soar/logs/migrations

# Move environment file for production to match naming convention
# For consistency, production uses /etc/soar/env-production (like staging uses env-staging)
if [ "$ENVIRONMENT" = "production" ]; then
    if [ -f /etc/soar/env ] && [ ! -f /etc/soar/env-production ]; then
        echo -e "${BLUE}Moving /etc/soar/env to /etc/soar/env-production...${NC}"
        sudo mv /etc/soar/env /etc/soar/env-production
        echo -e "${GREEN}Environment file renamed to /etc/soar/env-production${NC}"
    elif [ -f /etc/soar/env-production ]; then
        echo -e "${YELLOW}/etc/soar/env-production already exists${NC}"
    else
        echo -e "${YELLOW}No environment file found to move${NC}"
    fi
fi

# Reload systemd daemon
echo "Reloading systemd daemon..."
sudo systemctl daemon-reload

# Configure Prometheus
echo -e "${BLUE}Configuring Prometheus...${NC}"
sudo mkdir -p /etc/prometheus/jobs
sudo cp infrastructure/prometheus.yml /etc/prometheus/prometheus.yml
sudo cp infrastructure/prometheus-defaults /etc/default/prometheus

# Set Prometheus ownership
sudo chown prometheus:prometheus /etc/prometheus/prometheus.yml
sudo chown prometheus:prometheus /etc/prometheus/jobs

echo -e "${GREEN}Prometheus configured${NC}"

# Configure Grafana
echo -e "${BLUE}Configuring Grafana...${NC}"
sudo mkdir -p /etc/grafana/provisioning/dashboards
sudo mkdir -p /etc/grafana/provisioning/datasources
sudo mkdir -p /etc/grafana/dashboards

# Copy Grafana dashboard provisioning configuration
if [ -f infrastructure/grafana-provisioning/dashboards/dashboards.yml ]; then
    sudo cp infrastructure/grafana-provisioning/dashboards/dashboards.yml /etc/grafana/provisioning/dashboards/
    sudo chown grafana:grafana /etc/grafana/provisioning/dashboards/dashboards.yml
    echo "Grafana dashboard provisioning configuration installed"
fi

# Copy all Grafana datasource provisioning configurations (Prometheus, Loki, Tempo, Pyroscope)
DATASOURCE_COUNT=0
for datasource_file in infrastructure/grafana-provisioning/datasources/*.yaml infrastructure/grafana-provisioning/datasources/*.yml; do
    if [ -f "$datasource_file" ]; then
        sudo cp "$datasource_file" /etc/grafana/provisioning/datasources/
        DATASOURCE_COUNT=$((DATASOURCE_COUNT + 1))
        echo "  Installed datasource: $(basename "$datasource_file")"
    fi
done
sudo chown -R grafana:grafana /etc/grafana/provisioning/datasources
echo "Installed $DATASOURCE_COUNT Grafana datasource configuration(s)"

# Copy Grafana dashboards
DASHBOARD_COUNT=0
if compgen -G "infrastructure/grafana-dashboard-*.json" > /dev/null; then
    sudo cp infrastructure/grafana-dashboard-*.json /etc/grafana/dashboards/
    sudo chown -R grafana:grafana /etc/grafana/dashboards
    DASHBOARD_COUNT=$(ls -1 infrastructure/grafana-dashboard-*.json | wc -l)
    echo "Installed $DASHBOARD_COUNT Grafana dashboard(s)"
fi

echo -e "${GREEN}Grafana configured with $DASHBOARD_COUNT dashboards and Prometheus datasource${NC}"

# Configure Caddy
echo -e "${BLUE}Configuring Caddy web server...${NC}"

# Create Caddy log directory
sudo mkdir -p /var/log/caddy
sudo chown caddy:caddy /var/log/caddy

# Create SOAR Caddy configuration directory
sudo mkdir -p /etc/soar/caddy
sudo chown root:root /etc/soar/caddy
sudo chmod 755 /etc/soar/caddy

# Remove old monolithic config files (from pre-modular setup)
if [ -f "/etc/soar/caddy/soar-production.conf" ]; then
    echo "Removing old monolithic config: soar-production.conf"
    sudo rm -f /etc/soar/caddy/soar-production.conf
fi
if [ -f "/etc/soar/caddy/soar-staging.conf" ]; then
    echo "Removing old monolithic config: soar-staging.conf"
    sudo rm -f /etc/soar/caddy/soar-staging.conf
fi

# Install site-specific Caddy configs for this environment
echo "Installing Caddy site configs for $ENVIRONMENT environment..."
for site in "${CADDY_SITES[@]}"; do
    SITE_SOURCE="infrastructure/caddy/${site}.conf"
    SITE_DEST="/etc/soar/caddy/${site}.conf"

    if [ -f "$SITE_SOURCE" ]; then
        sudo cp "$SITE_SOURCE" "$SITE_DEST"
        sudo chown root:root "$SITE_DEST"
        sudo chmod 644 "$SITE_DEST"
        echo "  Installed ${site}.conf"
    else
        echo -e "${RED}Error: $SITE_SOURCE not found${NC}"
        exit 1
    fi
done

# Ensure main Caddyfile imports SOAR configs
MAIN_CADDYFILE="/etc/caddy/Caddyfile"
IMPORT_LINE="import /etc/soar/caddy/*"

# Create main Caddyfile if it doesn't exist
if [ ! -f "$MAIN_CADDYFILE" ]; then
    echo -e "${YELLOW}Creating main Caddyfile with import directive...${NC}"
    echo "# Main Caddyfile - imports SOAR site configurations" | sudo tee "$MAIN_CADDYFILE" > /dev/null
    echo "$IMPORT_LINE" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
    sudo chown root:root "$MAIN_CADDYFILE"
    sudo chmod 644 "$MAIN_CADDYFILE"
    echo "Created $MAIN_CADDYFILE with import directive"
else
    # Check if import directive already exists
    if ! sudo grep -qF "$IMPORT_LINE" "$MAIN_CADDYFILE"; then
        echo -e "${YELLOW}Adding import directive to existing Caddyfile...${NC}"
        # Backup existing Caddyfile
        sudo cp "$MAIN_CADDYFILE" "$MAIN_CADDYFILE.backup.$(date +%Y%m%d_%H%M%S)"
        # Add import directive at the end
        echo "" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "# Import SOAR site configurations" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "$IMPORT_LINE" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "Added import directive to $MAIN_CADDYFILE (backup created)"
    else
        echo -e "${BLUE}Import directive already exists in $MAIN_CADDYFILE${NC}"
    fi
fi

# Validate Caddyfile syntax
if command -v caddy &> /dev/null; then
    if sudo caddy validate --config "$MAIN_CADDYFILE" 2>/dev/null; then
        echo -e "${GREEN}Caddyfile validation passed${NC}"
    else
        echo -e "${YELLOW}Warning: Caddyfile validation failed. Check configuration manually.${NC}"
    fi
fi

echo -e "${GREEN}Caddy configured for $ENVIRONMENT environment with ${#CADDY_SITES[@]} site(s)${NC}"

# Configure Loki
echo -e "${BLUE}Configuring Loki...${NC}"
sudo mkdir -p /etc/loki
sudo mkdir -p /var/lib/loki
sudo cp infrastructure/loki-config.yml /etc/loki/config.yml
sudo chown -R loki:loki /etc/loki
sudo chown -R loki:loki /var/lib/loki
echo -e "${GREEN}Loki configured${NC}"

# Configure Tempo
echo -e "${BLUE}Configuring Tempo...${NC}"
sudo mkdir -p /etc/tempo
sudo mkdir -p /var/lib/tempo
sudo mkdir -p /var/lib/tempo/blocks
sudo mkdir -p /var/lib/tempo/wal
sudo mkdir -p /var/lib/tempo/generator/wal
sudo cp infrastructure/tempo.yaml /etc/tempo/config.yml
sudo chown -R tempo:tempo /etc/tempo
sudo chown -R tempo:tempo /var/lib/tempo
echo -e "${GREEN}Tempo configured${NC}"

# Configure Pyroscope
echo -e "${BLUE}Configuring Pyroscope...${NC}"
sudo mkdir -p /etc/pyroscope
sudo mkdir -p /var/lib/pyroscope
sudo cp infrastructure/pyroscope-config.yml /etc/pyroscope/config.yml
sudo chown -R pyroscope:pyroscope /etc/pyroscope
sudo chown -R pyroscope:pyroscope /var/lib/pyroscope

# Install Pyroscope systemd override for single-node deployment
sudo mkdir -p /etc/systemd/system/pyroscope.service.d
sudo cp infrastructure/pyroscope-systemd-override.conf /etc/systemd/system/pyroscope.service.d/override.conf
echo -e "${GREEN}Pyroscope configured${NC}"

# Configure Alloy
echo -e "${BLUE}Configuring Alloy...${NC}"
sudo mkdir -p /etc/alloy
sudo mkdir -p /var/lib/alloy
sudo cp infrastructure/alloy-config.alloy /etc/alloy/config.alloy
sudo chown -R alloy:alloy /etc/alloy
sudo chown -R alloy:alloy /var/lib/alloy
echo -e "${GREEN}Alloy configured${NC}"

# Enable infrastructure services
# Note: SOAR application services are enabled by soar-deploy
echo -e "${BLUE}Enabling infrastructure services...${NC}"
sudo systemctl enable nats-server.service
sudo systemctl enable prometheus-nats-exporter.service
sudo systemctl enable prometheus
sudo systemctl enable grafana-server
sudo systemctl enable caddy
sudo systemctl enable pyroscope
sudo systemctl enable alloy
sudo systemctl enable loki
sudo systemctl enable tempo

# Start Prometheus if not already running
if ! systemctl is-active --quiet prometheus; then
    echo -e "${BLUE}Starting Prometheus...${NC}"
    sudo systemctl start prometheus
    if systemctl is-active --quiet prometheus; then
        echo -e "${GREEN}Prometheus started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Prometheus. Check logs with: journalctl -u prometheus -n 50${NC}"
    fi
else
    echo -e "${BLUE}Prometheus is already running${NC}"
fi

# Start Grafana if not already running
if ! systemctl is-active --quiet grafana-server; then
    echo -e "${BLUE}Starting Grafana...${NC}"
    sudo systemctl start grafana-server
    if systemctl is-active --quiet grafana-server; then
        echo -e "${GREEN}Grafana started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Grafana. Check logs with: journalctl -u grafana-server -n 50${NC}"
    fi
else
    echo -e "${BLUE}Grafana is already running${NC}"
fi

# Start Caddy if not already running
if ! systemctl is-active --quiet caddy; then
    echo -e "${BLUE}Starting Caddy...${NC}"
    sudo systemctl start caddy
    if systemctl is-active --quiet caddy; then
        echo -e "${GREEN}Caddy started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Caddy. Check logs with: journalctl -u caddy -n 50${NC}"
    fi
else
    echo -e "${BLUE}Caddy is already running${NC}"
fi

# Start Pyroscope if not already running
if ! systemctl is-active --quiet pyroscope; then
    echo -e "${BLUE}Starting Pyroscope...${NC}"
    sudo systemctl start pyroscope
    if systemctl is-active --quiet pyroscope; then
        echo -e "${GREEN}Pyroscope started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Pyroscope. Check logs with: journalctl -u pyroscope -n 50${NC}"
    fi
else
    echo -e "${BLUE}Pyroscope is already running${NC}"
fi

# Start Alloy if not already running
if ! systemctl is-active --quiet alloy; then
    echo -e "${BLUE}Starting Alloy...${NC}"
    sudo systemctl start alloy
    if systemctl is-active --quiet alloy; then
        echo -e "${GREEN}Alloy started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Alloy. Check logs with: journalctl -u alloy -n 50${NC}"
    fi
else
    echo -e "${BLUE}Alloy is already running${NC}"
fi

# Start Loki if not already running
if ! systemctl is-active --quiet loki; then
    echo -e "${BLUE}Starting Loki...${NC}"
    sudo systemctl start loki
    if systemctl is-active --quiet loki; then
        echo -e "${GREEN}Loki started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Loki. Check logs with: journalctl -u loki -n 50${NC}"
    fi
else
    echo -e "${BLUE}Loki is already running${NC}"
fi

# Start Tempo if not already running
if ! systemctl is-active --quiet tempo; then
    echo -e "${BLUE}Starting Tempo...${NC}"
    sudo systemctl start tempo
    if systemctl is-active --quiet tempo; then
        echo -e "${GREEN}Tempo started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Tempo. Check logs with: journalctl -u tempo -n 50${NC}"
    fi
else
    echo -e "${BLUE}Tempo is already running${NC}"
fi

# Create necessary directories
echo -e "${BLUE}Creating directories...${NC}"
sudo mkdir -p /var/lib/soar/logs
sudo mkdir -p /var/lib/soar/archive
sudo mkdir -p /var/lib/soar/elevation
sudo mkdir -p /etc/soar
sudo mkdir -p /var/lib/nats/jetstream
sudo mkdir -p /storage/soar/backups/base
sudo mkdir -p /var/lib/pyroscope
sudo mkdir -p /etc/pyroscope
sudo mkdir -p /var/lib/alloy
sudo mkdir -p /etc/alloy

# Set ownership for soar user
echo -e "${BLUE}Setting ownership for soar user...${NC}"
sudo chown -R soar:soar /var/lib/soar
sudo chown -R soar:soar /var/lib/soar/archive
sudo chown soar:soar /home/soar
sudo chmod 755 /home/soar

# Set ownership for backup temp directory (used by postgres user)
echo -e "${BLUE}Setting ownership for backup temp directory...${NC}"
sudo chown -R postgres:postgres /storage/soar/backups/base
sudo chmod 750 /storage/soar/backups/base

# Set ownership for Pyroscope
echo -e "${BLUE}Setting ownership for Pyroscope...${NC}"
sudo chown -R pyroscope:pyroscope /var/lib/pyroscope
sudo chown -R pyroscope:pyroscope /etc/pyroscope
echo -e "${GREEN}Pyroscope directories configured${NC}"

# Set ownership for Alloy
echo -e "${BLUE}Setting ownership for Alloy...${NC}"
sudo chown -R alloy:alloy /var/lib/alloy
sudo chown -R alloy:alloy /etc/alloy
echo -e "${GREEN}Alloy directories configured${NC}"

# Download elevation data with rclone
echo -e "${BLUE}Setting up elevation data...${NC}"

# Check if rclone is installed
if ! command -v rclone &> /dev/null; then
    echo "Installing rclone..."
    sudo apt-get install -y rclone
fi

# Download elevation tiles
if command -v rclone &> /dev/null; then
    echo -e "${BLUE}Downloading elevation tiles from S3 (this may take some time)...${NC}"
    echo -e "${YELLOW}Note: This will download ~50GB+ of worldwide elevation data${NC}"
    echo -e "${YELLOW}Using --size-only to skip files that already match${NC}"

    # Download with progress, using --size-only to skip matching files without checksumming
    # This allows resuming interrupted downloads efficiently
    sudo rclone copy --progress --size-only \
        :s3,provider=AWS,anonymous=true,region=us-east-1:elevation-tiles-prod/skadi \
        /var/lib/soar/elevation

    # Set ownership
    sudo chown -R soar:soar /var/lib/soar/elevation

    echo -e "${GREEN}Elevation data download complete${NC}"
else
    echo -e "${YELLOW}Warning: rclone not available. Skipping elevation data download.${NC}"
    echo -e "${YELLOW}You will need to download elevation data manually to /var/lib/soar/elevation${NC}"
    echo -e "${YELLOW}See infrastructure/DEPLOYMENT.md for instructions${NC}"
fi

# Set ownership for NATS JetStream storage
echo -e "${BLUE}Setting ownership for NATS JetStream storage...${NC}"
sudo chown -R daemon:daemon /var/lib/nats/jetstream
echo -e "${GREEN}NATS JetStream storage configured${NC}"

# Configure PostgreSQL authentication
echo -e "${BLUE}Configuring PostgreSQL authentication...${NC}"

# Determine pg_hba.conf location
PG_HBA_CONF="/etc/postgresql/18/main/pg_hba.conf"
PG_CONF_DIR="/etc/postgresql/18/main"

if [ ! -f "$PG_HBA_CONF" ]; then
    echo -e "${RED}Error: pg_hba.conf not found at $PG_HBA_CONF${NC}"
    exit 1
fi

# Backup pg_hba.conf
echo "Backing up pg_hba.conf..."
sudo cp "$PG_HBA_CONF" "$PG_HBA_CONF.backup.$(date +%Y%m%d_%H%M%S)"

# Check if trust authentication is already configured for soar user
NEEDS_RELOAD=false

if ! grep -q "^local.*soar.*soar.*trust" "$PG_HBA_CONF"; then
    echo "Adding Unix socket trust authentication for soar user..."
    sudo sed -i "/^# \"local\" is for Unix domain socket connections only/a local   soar            soar                                    trust" "$PG_HBA_CONF"
    NEEDS_RELOAD=true
fi

# Only add TCP trust entry for the current environment's database
if ! grep -q "^host.*${DB_NAME}.*soar.*127.0.0.1/32.*trust" "$PG_HBA_CONF"; then
    echo "Adding TCP localhost trust authentication for soar user to ${DB_NAME} database..."
    sudo sed -i "/^# IPv4 local connections:/a host    ${DB_NAME}      soar            127.0.0.1/32            trust" "$PG_HBA_CONF"
    NEEDS_RELOAD=true
fi

if [ "$NEEDS_RELOAD" = true ]; then
    echo "Reloading PostgreSQL configuration..."
    sudo systemctl reload postgresql
    echo -e "${GREEN}PostgreSQL authentication configured for trust on local connections${NC}"
else
    echo -e "${BLUE}PostgreSQL authentication already correctly configured${NC}"
fi

# Create PostgreSQL databases and enable extensions
echo -e "${BLUE}Creating PostgreSQL database: $DB_NAME...${NC}"

# Create soar database user if it doesn't exist (without password)
sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'soar'" | grep -q 1 || \
    sudo -u postgres psql -c "CREATE USER soar;"

echo -e "${GREEN}PostgreSQL 'soar' user configured with trust authentication${NC}"
echo

# Create environment-specific database
if sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
    echo -e "${BLUE}Database '$DB_NAME' already exists${NC}"
else
    echo "Creating '$DB_NAME' database..."
    sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER soar;"
    echo -e "${GREEN}Database '$DB_NAME' created${NC}"
fi

# Enable PostGIS extension on database
echo -e "${BLUE}Enabling PostGIS extension on '$DB_NAME' database...${NC}"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE EXTENSION IF NOT EXISTS postgis;"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE EXTENSION IF NOT EXISTS postgis_topology;"
echo -e "${GREEN}PostGIS enabled on '$DB_NAME' database${NC}"

# Enable pg_partman extension on database
echo -e "${BLUE}Enabling pg_partman extension on '$DB_NAME' database...${NC}"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE SCHEMA IF NOT EXISTS partman;"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE EXTENSION IF NOT EXISTS pg_partman SCHEMA partman;"
echo -e "${GREEN}pg_partman enabled on '$DB_NAME' database${NC}"

echo -e "${GREEN}Database setup complete!${NC}"
echo

echo -e "${GREEN}Server provisioning complete for $ENVIRONMENT environment!${NC}"
echo
echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}IMPORTANT: Manual Configuration Steps Required${NC}"
echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
echo
echo -e "${YELLOW}1. Configure environment variables:${NC}"
echo "   Create/edit $ENV_FILE and set:"
echo
echo "   DATABASE_URL=postgres://soar@localhost/$DB_NAME"
echo
echo -e "${YELLOW}2. Set up additional environment variables in $ENV_FILE:${NC}"
echo "   - NATS_URL (e.g., nats://localhost:4222)"
echo "   - APRS_CALLSIGN (for APRS-IS connection)"
echo "   - Any other application-specific configuration"
echo
echo -e "${YELLOW}3. Run database migrations:${NC}"
echo "   cd /path/to/soar"
echo "   diesel migration run --database-url=postgres://soar@localhost/$DB_NAME"
echo
echo -e "${YELLOW}4. Deploy SOAR application:${NC}"
echo "   Run the first deployment with soar-deploy to install SOAR services"
echo "   SOAR services will be managed by soar-deploy on each deployment"
echo
echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
echo
echo -e "${YELLOW}Infrastructure service control:${NC}"
echo "  Start services:"
echo "    sudo systemctl start nats-server"
echo "    sudo systemctl start prometheus"
echo "    sudo systemctl start prometheus-nats-exporter"
echo "    sudo systemctl start grafana-server"
echo "    sudo systemctl start caddy"
echo "    sudo systemctl start pyroscope"
echo "    sudo systemctl start alloy"
echo "    sudo systemctl start loki"
echo "    sudo systemctl start tempo"
echo
echo "  Check service status:"
echo "    sudo systemctl status nats-server"
echo "    sudo systemctl status prometheus"
echo "    sudo systemctl status prometheus-nats-exporter"
echo "    sudo systemctl status grafana-server"
echo "    sudo systemctl status caddy"
echo "    sudo systemctl status pyroscope"
echo "    sudo systemctl status alloy"
echo "    sudo systemctl status loki"
echo "    sudo systemctl status tempo"
echo
echo -e "${YELLOW}Check infrastructure logs:${NC}"
echo "  sudo journalctl -u nats-server -f"
echo "  sudo journalctl -u prometheus -f"
echo "  sudo journalctl -u prometheus-nats-exporter -f"
echo "  sudo journalctl -u grafana-server -f"
echo "  sudo journalctl -u caddy -f"
echo "  sudo journalctl -u pyroscope -f"
echo "  sudo journalctl -u alloy -f"
echo "  sudo journalctl -u loki -f"
echo "  sudo journalctl -u tempo -f"
echo
echo -e "${YELLOW}Database verification:${NC}"
echo "  sudo -u postgres psql -l  # List all databases"
echo "  sudo -u postgres psql -d $DB_NAME -c '\\dx'  # List extensions in database"
echo
echo -e "${YELLOW}Elevation Data:${NC}"
echo "  Location: /var/lib/soar/elevation"
echo "  Verify tiles: ls -lh /var/lib/soar/elevation/"
echo "  Test a tile: gzip -t /var/lib/soar/elevation/N45/N45E009.hgt.gz"
TILE_COUNT=$(find /var/lib/soar/elevation -name '*.hgt.gz' 2>/dev/null | wc -l)
if [ "$TILE_COUNT" -eq 0 ]; then
    echo -e "  ${YELLOW}WARNING: No elevation tiles found!${NC}"
    echo "  rclone may have failed. See infrastructure/DEPLOYMENT.md for manual download."
else
    echo "  Tiles installed: $TILE_COUNT"
    echo "  To resume/update: Re-run provision script or use rclone command from DEPLOYMENT.md"
fi
echo
echo -e "${YELLOW}PostgreSQL Authentication:${NC}"
echo "  Local connections (Unix socket and TCP 127.0.0.1) use 'trust' authentication"
echo "  No password required for the 'soar' user on local connections"
echo "  pg_hba.conf backup saved to: $PG_HBA_CONF.backup.*"
echo
echo -e "${YELLOW}NATS JetStream:${NC}"
echo "  NATS server installed with JetStream enabled"
echo "  JetStream storage: /var/lib/nats/jetstream"
echo "  HTTP monitoring: http://localhost:8222"
echo "  Verify NATS is running: curl http://localhost:8222/varz"
echo "  Verify JetStream: curl http://localhost:8222/jsz"
echo
echo -e "${YELLOW}Prometheus:${NC}"
echo "  Configuration: /etc/prometheus/prometheus.yml"
echo "  Job configs: /etc/prometheus/jobs/*.yml (will be deployed by soar-deploy)"
echo "  Web UI: http://localhost:9090"
echo "  Verify Prometheus: curl http://localhost:9090/-/healthy"
echo "  Data storage: /var/lib/prometheus"
echo
echo -e "${YELLOW}Grafana:${NC}"
echo "  Web UI: http://localhost:3000"
echo "  Default credentials: admin / admin (you will be prompted to change on first login)"
echo "  Dashboards: $DASHBOARD_COUNT SOAR dashboards automatically installed in 'SOAR' folder"
echo "  Prometheus datasource: Automatically configured and ready to use"
echo "  Configuration: /etc/grafana/grafana.ini"
echo "  NOTE: After starting Grafana, dashboards will be immediately available"
echo
echo -e "${YELLOW}Caddy Web Server (${ENVIRONMENT^^}):${NC}"
echo "  Main configuration: /etc/caddy/Caddyfile (imports from /etc/soar/caddy/*)"
echo "  SOAR site configs directory: /etc/soar/caddy/"
echo "  Installed sites for this environment:"
for site in "${CADDY_SITES[@]}"; do
    echo "    - /etc/soar/caddy/${site}.conf"
done
echo "  Logs: /var/log/caddy/"
echo "  Verify configuration: sudo caddy validate --config /etc/caddy/Caddyfile"
echo
echo -e "${YELLOW}  NOTE: Site-based configuration (modular)${NC}"
echo "    Each site has its own config file in /etc/soar/caddy/"
echo "    Production sites: glider.flights, pelias.glider.flights, grafana.glider.flights"
echo "    Staging sites: staging.glider.flights, grafana.staging.glider.flights"
echo "    Multiple environments can coexist - files are imported by main Caddyfile"
echo
echo -e "${YELLOW}  IMPORTANT - DNS Configuration Required:${NC}"
echo "    Before Caddy can serve HTTPS, configure DNS A/AAAA records:"
for site in "${CADDY_SITES[@]}"; do
    echo "      ${site} → <server-ip>"
done
echo
echo "    Caddy will automatically obtain Let's Encrypt certificates once DNS is configured."
echo "    Test configuration: caddy run --config /etc/caddy/Caddyfile --adapter caddyfile"
echo
echo -e "${YELLOW}Pyroscope Continuous Profiling:${NC}"
echo "  Local Web UI: http://localhost:4040"
echo "  Configuration: /etc/pyroscope/config.yml"
echo "  Data directory: /var/lib/pyroscope"
echo "  Logs: sudo journalctl -u pyroscope -f"
echo "  Service status: sudo systemctl status pyroscope"
echo "  Grafana datasource: Automatically provisioned as 'Pyroscope'"
echo "  Retention: 30 days (configured in config.yml)"
echo ""
echo "  Features:"
echo "    • CPU profiling via pprof endpoints"
echo "    • Continuous profiling collection"
echo "    • Flamegraph visualization in Grafana"
echo "    • Profile comparison and diff"
echo ""
echo "  Access in Grafana:"
echo "    1. Navigate to Explore → Select 'Pyroscope' datasource"
echo "    2. Query profiles by service name, time range, or labels"
echo "    3. View flamegraphs and analyze performance bottlenecks"
echo
echo -e "${YELLOW}Grafana Alloy (Profiling Collector):${NC}"
echo "  Configuration: /etc/alloy/config.alloy"
echo "  Data directory: /var/lib/alloy"
echo "  Logs: sudo journalctl -u alloy -f"
echo "  Service status: sudo systemctl status alloy"
echo "  HTTP API: http://localhost:12345"
echo "  Metrics endpoint: http://localhost:12345/metrics"
echo ""
echo "  Alloy automatically:"
echo "    • Discovers SOAR services via configured targets"
echo "    • Scrapes pprof endpoints (/debug/pprof/profile)"
echo "    • Sends profiles to Pyroscope for storage and visualization"
echo ""
echo "  Profiled services:"
echo "    • soar-run (localhost:9090)"
echo "    • soar-web (localhost:9091)"
echo "    • soar-ingest-ogn (localhost:9092)"
echo "    • soar-ingest-adsb (localhost:9093)"
if [[ "$ENVIRONMENT" == "staging" ]]; then
    echo "    • soar-run-staging (localhost:9094)"
    echo "    • soar-web-staging (localhost:9095)"
fi
echo ""
echo "  Note: Alloy configuration is deployed via soar-deploy"
echo
echo -e "${YELLOW}Grafana Loki (Log Aggregation):${NC}"
echo "  HTTP API: http://localhost:3100"
echo "  gRPC API: localhost:9098"
echo "  Configuration: /etc/loki/config.yml"
echo "  Data directory: /var/lib/loki"
echo "  Logs: sudo journalctl -u loki -f"
echo "  Service status: sudo systemctl status loki"
echo "  Grafana datasource: Automatically provisioned as 'Loki'"
echo ""
echo "  Features:"
echo "    • Aggregates logs from SOAR services via OTLP"
echo "    • Full-text search and structured metadata"
echo "    • Integrated with Grafana for log visualization"
echo "    • Links logs to traces via trace_id field"
echo ""
echo "  Access in Grafana:"
echo "    1. Navigate to Explore → Select 'Loki' datasource"
echo "    2. Use LogQL to query logs by service, level, or content"
echo "    3. Click trace IDs to jump to Tempo traces"
echo
echo -e "${YELLOW}Grafana Tempo (Distributed Tracing):${NC}"
echo "  HTTP API: http://localhost:3200"
echo "  gRPC API: localhost:9097"
echo "  OTLP HTTP receiver: http://localhost:4320"
echo "  Configuration: /etc/tempo/config.yml"
echo "  Data directory: /var/lib/tempo"
echo "  Logs: sudo journalctl -u tempo -f"
echo "  Service status: sudo systemctl status tempo"
echo "  Grafana datasource: Automatically provisioned as 'Tempo'"
echo "  Retention: 7 days (configured in config.yaml)"
echo ""
echo "  Features:"
echo "    • Receives traces via OTLP from Alloy"
echo "    • Service graph visualization"
echo "    • Trace search by service, duration, or tags"
echo "    • Links traces to logs and metrics"
echo ""
echo "  Access in Grafana:"
echo "    1. Navigate to Explore → Select 'Tempo' datasource"
echo "    2. Search traces by service name, duration, or trace ID"
echo "    3. View service dependency graph and span details"
echo
echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}Database Migration System${NC}"
echo -e "${BLUE}=========================================${NC}"
echo
echo -e "${GREEN}✓ Migration service installed: soar-migrate@${ENVIRONMENT}.service${NC}"
echo
echo -e "${YELLOW}Migration Features:${NC}"
echo "  • Runs soar migrate command directly (no wrapper script)"
echo "  • Asynchronous execution via systemd"
echo "  • Survives SSH disconnects"
echo "  • Email notifications on success and failure (sent by Rust)"
echo "  • Sentry alerts on success and failure (sent by Rust)"
echo "  • All output logged to systemd journal"
echo "  • No timeout limit (deployment has 2-hour polling timeout)"
echo
echo -e "${YELLOW}Migration Usage:${NC}"
echo "  Manual migration run:"
echo "    sudo systemctl start soar-migrate@${ENVIRONMENT}"
echo
echo "  Check migration status:"
echo "    systemctl status soar-migrate@${ENVIRONMENT}"
echo "    systemctl is-active soar-migrate@${ENVIRONMENT}"
echo "    systemctl is-failed soar-migrate@${ENVIRONMENT}"
echo
echo "  View migration logs:"
echo "    journalctl -u soar-migrate@${ENVIRONMENT} -f"
echo "    journalctl -u soar-migrate@${ENVIRONMENT} -n 100"
echo
echo -e "${YELLOW}Note:${NC} soar-deploy automatically uses this migration system"
echo
echo -e "${GREEN}=========================================${NC}"
echo -e "${GREEN}Server provisioning complete for $ENVIRONMENT environment!${NC}"
echo -e "${GREEN}=========================================${NC}"
