#!/bin/bash
# SOAR Server Provisioning Script
#
# This script provisions a server for SOAR by installing systemd services,
# setting up deployment privileges, and configuring the environment.
#
# Usage:
#   sudo ./provision <staging|production>
#
# Arguments:
#   staging     - Provision for staging environment (soar_staging database, staging.glider.flights)
#   production  - Provision for production environment (soar database, glider.flights)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check for required argument
if [ $# -ne 1 ]; then
    echo -e "${RED}Error: Environment argument required${NC}"
    echo "Usage: $0 <staging|production>"
    echo ""
    echo "Arguments:"
    echo "  staging     - Provision for staging environment (soar_staging database)"
    echo "  production  - Provision for production environment (soar database)"
    exit 1
fi

ENVIRONMENT="$1"

# Validate environment argument
if [[ "$ENVIRONMENT" != "staging" ]] && [[ "$ENVIRONMENT" != "production" ]]; then
    echo -e "${RED}Error: Invalid environment '$ENVIRONMENT'${NC}"
    echo "Must be either 'staging' or 'production'"
    exit 1
fi

# Set environment-specific variables
if [[ "$ENVIRONMENT" == "production" ]]; then
    DB_NAME="soar"
    ENV_FILE="/etc/soar/env"
    WEB_PORT="61225"
    DOMAIN="glider.flights"
    # Caddy site configs to install for production
    CADDY_SITES=("glider.flights" "photon.glider.flights" "pelias.glider.flights" "grafana.glider.flights")
else
    DB_NAME="soar_staging"
    ENV_FILE="/etc/soar/env-staging"
    WEB_PORT="61226"
    DOMAIN="staging.glider.flights"
    # Caddy site configs to install for staging
    CADDY_SITES=("staging.glider.flights" "pelias.staging.glider.flights" "grafana.staging.glider.flights")
fi

echo -e "${GREEN}Provisioning SOAR server for ${ENVIRONMENT} environment...${NC}"
echo -e "${BLUE}Database: $DB_NAME${NC}"
echo -e "${BLUE}Environment file: $ENV_FILE${NC}"
echo -e "${BLUE}Web port: $WEB_PORT${NC}"
echo -e "${BLUE}Domain: $DOMAIN${NC}"
echo ""

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root (use sudo)${NC}"
   exit 1
fi

# Detect OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    OS_VERSION=$VERSION_ID
else
    echo -e "${RED}Error: Cannot detect OS. /etc/os-release not found.${NC}"
    exit 1
fi

echo -e "${BLUE}Detected OS: $OS $OS_VERSION${NC}"

# Check if OS is Debian or Ubuntu - EXIT IMMEDIATELY IF NOT
if [[ "$OS" != "ubuntu" ]] && [[ "$OS" != "debian" ]]; then
    echo -e "${RED}Error: This script only supports Debian and Ubuntu.${NC}"
    echo -e "${RED}Detected OS: $OS${NC}"
    echo -e "${YELLOW}Please run this script on a Debian or Ubuntu system.${NC}"
    exit 1
fi

# Install PostgreSQL 18
echo -e "${BLUE}Installing PostgreSQL 18...${NC}"

# Add PostgreSQL APT repository
echo "Adding PostgreSQL APT repository..."
sudo apt-get update
sudo apt-get install -y wget ca-certificates lsb-release gnupg

# Add PostgreSQL GPG key (modern method, not using deprecated apt-key)
sudo mkdir -p /etc/apt/keyrings
if [ ! -f /etc/apt/keyrings/postgresql.gpg ]; then
    wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | \
        sudo gpg --dearmor -o /etc/apt/keyrings/postgresql.gpg
fi

# Add PostgreSQL repository with signed-by
echo "deb [signed-by=/etc/apt/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | \
    sudo tee /etc/apt/sources.list.d/pgdg.list

# Install PostgreSQL 18 and PostGIS
sudo apt-get update
sudo apt-get install -y postgresql-18 postgresql-client-18 postgresql-18-postgis-3 postgresql-18-partman uuid-runtime

echo -e "${GREEN}PostgreSQL 18 installed successfully${NC}"

# Install TimescaleDB
echo -e "${BLUE}Installing TimescaleDB...${NC}"

# Add TimescaleDB GPG key
sudo mkdir -p /usr/share/keyrings
if [ ! -f /usr/share/keyrings/timescaledb.gpg ]; then
    curl -fsSL https://packagecloud.io/timescale/timescaledb/gpgkey | \
        sudo gpg --dearmor -o /usr/share/keyrings/timescaledb.gpg
fi

# Add TimescaleDB repository
echo "deb [signed-by=/usr/share/keyrings/timescaledb.gpg] https://packagecloud.io/timescale/timescaledb/debian/ $(lsb_release -cs) main" | \
    sudo tee /etc/apt/sources.list.d/timescaledb.list

# Install TimescaleDB packages
sudo apt-get update
sudo apt-get install -y timescaledb-toolkit-postgresql-18 timescaledb-tools timescaledb-2-postgresql-18

echo -e "${GREEN}TimescaleDB installed successfully${NC}"

# Configure PostgreSQL to load TimescaleDB
echo -e "${BLUE}Configuring PostgreSQL to load TimescaleDB...${NC}"

POSTGRESQL_CONF="/etc/postgresql/18/main/postgresql.conf"
TIMESCALEDB_CONFIG_CHANGED=false

# Backup postgresql.conf
sudo cp "$POSTGRESQL_CONF" "$POSTGRESQL_CONF.backup.$(date +%Y%m%d_%H%M%S)"

# Check if shared_preload_libraries already includes timescaledb
if grep -q "^shared_preload_libraries.*timescaledb" "$POSTGRESQL_CONF"; then
    echo -e "${BLUE}TimescaleDB already configured in shared_preload_libraries${NC}"
elif grep -q "^#shared_preload_libraries" "$POSTGRESQL_CONF"; then
    # Uncomment and set to timescaledb
    sudo sed -i "s/^#shared_preload_libraries.*/shared_preload_libraries = 'timescaledb'/" "$POSTGRESQL_CONF"
    echo -e "${GREEN}Enabled and set shared_preload_libraries = 'timescaledb'${NC}"
    TIMESCALEDB_CONFIG_CHANGED=true
elif grep -q "^shared_preload_libraries" "$POSTGRESQL_CONF"; then
    # Append timescaledb to existing value
    sudo sed -i "s/^shared_preload_libraries = '\(.*\)'/shared_preload_libraries = '\1,timescaledb'/" "$POSTGRESQL_CONF"
    echo -e "${GREEN}Added timescaledb to existing shared_preload_libraries${NC}"
    TIMESCALEDB_CONFIG_CHANGED=true
else
    # Add new line
    echo "shared_preload_libraries = 'timescaledb'" | sudo tee -a "$POSTGRESQL_CONF" > /dev/null
    echo -e "${GREEN}Added shared_preload_libraries = 'timescaledb' to postgresql.conf${NC}"
    TIMESCALEDB_CONFIG_CHANGED=true
fi

# Ensure PostgreSQL is enabled
sudo systemctl enable postgresql

# Only restart if we changed the configuration
if [ "$TIMESCALEDB_CONFIG_CHANGED" = true ]; then
    echo -e "${BLUE}Restarting PostgreSQL to load TimescaleDB...${NC}"
    sudo systemctl restart postgresql
    echo -e "${GREEN}PostgreSQL service restarted with TimescaleDB enabled${NC}"
else
    # Just ensure it's running
    if ! systemctl is-active --quiet postgresql; then
        sudo systemctl start postgresql
        echo -e "${GREEN}PostgreSQL service started${NC}"
    else
        echo -e "${BLUE}PostgreSQL is already running${NC}"
    fi
fi

# Create soar user if it doesn't exist
if ! id "soar" &>/dev/null; then
    echo -e "${BLUE}Creating 'soar' system user...${NC}"
    sudo useradd --system --user-group --create-home --home-dir /home/soar --shell /bin/bash soar
    echo -e "${GREEN}'soar' user created successfully${NC}"
else
    echo -e "${BLUE}'soar' user already exists${NC}"
fi

# Install sudoers configuration for deployment
echo -e "${BLUE}Installing deployment sudoers configuration...${NC}"
sudo cp infrastructure/sudoers.d/soar /etc/sudoers.d/
sudo chmod 440 /etc/sudoers.d/soar

# Validate sudoers syntax
echo "Validating sudoers configuration..."
if ! sudo visudo -c -f /etc/sudoers.d/soar; then
    echo -e "${RED}Error: Invalid sudoers syntax. Removing file.${NC}"
    sudo rm -f /etc/sudoers.d/soar
    exit 1
fi

# Install NATS server binary if not already installed
if [ ! -f /usr/local/bin/nats-server ]; then
    echo -e "${BLUE}Installing NATS server binary...${NC}"
    NATS_VERSION="2.10.24"
    NATS_URL="https://github.com/nats-io/nats-server/releases/download/v${NATS_VERSION}/nats-server-v${NATS_VERSION}-linux-amd64.tar.gz"

    (
        cd /tmp
        wget -q "$NATS_URL" || { echo -e "${RED}Failed to download nats-server${NC}"; exit 1; }
        tar -xzf "nats-server-v${NATS_VERSION}-linux-amd64.tar.gz"
        sudo install -m 755 "nats-server-v${NATS_VERSION}-linux-amd64/nats-server" /usr/local/bin/
        rm -rf "nats-server-v${NATS_VERSION}-linux-amd64.tar.gz" "nats-server-v${NATS_VERSION}-linux-amd64"
    )
    echo -e "${GREEN}NATS server installed successfully${NC}"
else
    echo -e "${BLUE}NATS server already installed${NC}"
fi

# Install Prometheus
echo -e "${BLUE}Installing Prometheus...${NC}"
sudo apt-get update
sudo apt-get install -y prometheus
echo -e "${GREEN}Prometheus installed successfully${NC}"

# Install Grafana
echo -e "${BLUE}Installing Grafana...${NC}"

# Add Grafana APT repository
sudo apt-get install -y gnupg

# Add Grafana GPG key (modern method, not using deprecated apt-key)
sudo mkdir -p /etc/apt/keyrings
if [ ! -f /etc/apt/keyrings/grafana.gpg ]; then
    wget -q -O - https://apt.grafana.com/gpg.key | \
        sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
fi

# Add Grafana repository with signed-by
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | \
    sudo tee /etc/apt/sources.list.d/grafana.list

sudo apt-get update
sudo apt-get install -y grafana

echo -e "${GREEN}Grafana installed successfully${NC}"

# Install Caddy
echo -e "${BLUE}Installing Caddy web server...${NC}"

# Install Caddy from official Cloudsmith repository
sudo apt-get install -y debian-keyring debian-archive-keyring curl

# Add Caddy GPG key (Cloudsmith expects it in /usr/share/keyrings/)
sudo mkdir -p /usr/share/keyrings
if [ ! -f /usr/share/keyrings/caddy-stable-archive-keyring.gpg ]; then
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | \
        sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
fi

# Add Caddy repository (uses signed-by pointing to /usr/share/keyrings/)
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | \
    sudo tee /etc/apt/sources.list.d/caddy-stable.list

sudo apt-get update
sudo apt-get install -y caddy

echo -e "${GREEN}Caddy installed successfully${NC}"

# Install prometheus-nats-exporter binary if not already installed
if [ ! -f /usr/local/bin/prometheus-nats-exporter ]; then
    echo -e "${BLUE}Installing prometheus-nats-exporter binary...${NC}"
    EXPORTER_VERSION="0.17.3"
    EXPORTER_URL="https://github.com/nats-io/prometheus-nats-exporter/releases/download/v${EXPORTER_VERSION}/prometheus-nats-exporter-v${EXPORTER_VERSION}-linux-x86_64.tar.gz"

    (
        cd /tmp
        wget -q "$EXPORTER_URL" || { echo -e "${RED}Failed to download prometheus-nats-exporter${NC}"; exit 1; }
        tar -xzf "prometheus-nats-exporter-v${EXPORTER_VERSION}-linux-x86_64.tar.gz"
        sudo install -m 755 prometheus-nats-exporter /usr/local/bin/
        rm -f "prometheus-nats-exporter-v${EXPORTER_VERSION}-linux-x86_64.tar.gz" prometheus-nats-exporter
    )
    echo -e "${GREEN}prometheus-nats-exporter installed successfully${NC}"
else
    echo -e "${BLUE}prometheus-nats-exporter already installed${NC}"
fi

# Install Photon geocoding server
echo -e "${BLUE}Installing Photon geocoding server...${NC}"

# Install Java and dependencies if not already installed
if ! command -v java &> /dev/null; then
    echo "Installing Java..."
    sudo apt-get update
    sudo apt-get install -y openjdk-21-jre-headless wget curl pbzip2
    echo -e "${GREEN}Java and dependencies installed successfully${NC}"
else
    echo -e "${BLUE}Java already installed: $(java -version 2>&1 | head -n 1)${NC}"
    # Ensure pbzip2 is installed for faster decompression
    if ! command -v pbzip2 &> /dev/null; then
        echo "Installing pbzip2 for faster decompression..."
        sudo apt-get install -y pbzip2 curl
    fi
fi

# Create photon user if it doesn't exist
if ! id "photon" &>/dev/null; then
    echo "Creating 'photon' system user..."
    sudo useradd --system --home-dir /opt/photon --shell /bin/false photon
    echo -e "${GREEN}'photon' user created successfully${NC}"
else
    echo -e "${BLUE}'photon' user already exists${NC}"
fi

# Create directory structure
echo "Creating Photon directories..."
sudo mkdir -p /opt/photon
sudo mkdir -p /var/lib/photon

# Set ownership
sudo chown -R photon:photon /opt/photon
sudo chown -R photon:photon /var/lib/photon

# Download Photon JAR if not already installed
PHOTON_JAR="photon-opensearch-0.7.4.jar"
PHOTON_URL="https://github.com/komoot/photon/releases/download/0.7.4/photon-opensearch-0.7.4.jar"

if [ ! -f "/opt/photon/${PHOTON_JAR}" ]; then
    echo "Downloading Photon OpenSearch 0.7.4..."

    (
        cd /opt/photon
        sudo -u photon wget -q "$PHOTON_URL" || { echo -e "${RED}Failed to download Photon JAR${NC}"; exit 1; }
        sudo -u photon ln -sf "${PHOTON_JAR}" photon.jar
    )
    echo -e "${GREEN}Photon JAR downloaded successfully${NC}"
else
    echo -e "${BLUE}Photon JAR already installed${NC}"
    # Ensure symlink exists
    if [ ! -L "/opt/photon/photon.jar" ]; then
        sudo -u photon ln -sf "${PHOTON_JAR}" /opt/photon/photon.jar
    fi
fi

# Download Photon data if not already downloaded
if [ ! -d "/var/lib/photon/photon_data" ] || [ -z "$(ls -A /var/lib/photon 2>/dev/null)" ]; then
    echo -e "${BLUE}Downloading Photon geocoding data (this may take a while)...${NC}"
    echo -e "${YELLOW}Note: This will download ~50-100GB of worldwide geocoding data${NC}"
    echo -e "${YELLOW}Using parallel decompression with pbzip2 for faster extraction${NC}"

    # Ensure directory exists
    sudo mkdir -p /var/lib/photon
    sudo chown photon:photon /var/lib/photon

    (
        cd /var/lib/photon
        # Download, decompress with pbzip2, and extract in one pipeline
        # This is much faster than wget + tar xjf as it decompresses in parallel
        sudo -u photon bash -lc '
          wget -O - https://download1.graphhopper.com/public/experimental/photon-db-planet-0.7OS-latest.tar.bz2 \
          | pbzip2 -cd \
          | tar -x
        ' || {
            echo -e "${YELLOW}Warning: Failed to download Photon data. You can download it manually later.${NC}"
            echo -e "${YELLOW}Manual command: cd /var/lib/photon && sudo -u photon bash -lc 'wget -O - https://download1.graphhopper.com/public/experimental/photon-db-planet-0.7OS-latest.tar.bz2 | pbzip2 -cd | tar -x'${NC}"
            echo -e "${YELLOW}See infrastructure/DEPLOYMENT.md or docs/photon-deployment.md for instructions${NC}"
        }

        if [ -d "photon_data" ]; then
            echo -e "${GREEN}Photon data extracted successfully${NC}"
        fi
    )
else
    echo -e "${BLUE}Photon data already exists${NC}"
fi

echo -e "${GREEN}Photon installation complete${NC}"

# Copy infrastructure service files
# Note: SOAR application service files (soar-run, soar-web, etc.) are installed by soar-deploy
echo -e "${BLUE}Installing infrastructure systemd service files...${NC}"
sudo cp infrastructure/nats-server.service /etc/systemd/system/
sudo cp infrastructure/prometheus-nats-exporter.service /etc/systemd/system/
sudo cp infrastructure/photon.service /etc/systemd/system/

# Reload systemd daemon
echo "Reloading systemd daemon..."
sudo systemctl daemon-reload

# Configure Prometheus
echo -e "${BLUE}Configuring Prometheus...${NC}"
sudo mkdir -p /etc/prometheus/jobs
sudo cp infrastructure/prometheus.yml /etc/prometheus/prometheus.yml

# Set Prometheus ownership
sudo chown prometheus:prometheus /etc/prometheus/prometheus.yml
sudo chown prometheus:prometheus /etc/prometheus/jobs

echo -e "${GREEN}Prometheus configured${NC}"

# Configure Grafana
echo -e "${BLUE}Configuring Grafana...${NC}"
sudo mkdir -p /etc/grafana/provisioning/dashboards
sudo mkdir -p /etc/grafana/provisioning/datasources
sudo mkdir -p /etc/grafana/dashboards

# Copy Grafana dashboard provisioning configuration
if [ -f infrastructure/grafana-provisioning/dashboards/dashboards.yml ]; then
    sudo cp infrastructure/grafana-provisioning/dashboards/dashboards.yml /etc/grafana/provisioning/dashboards/
    sudo chown grafana:grafana /etc/grafana/provisioning/dashboards/dashboards.yml
    echo "Grafana dashboard provisioning configuration installed"
fi

# Copy Grafana Prometheus datasource provisioning configuration
if [ -f infrastructure/grafana-provisioning/datasources/prometheus.yml ]; then
    sudo cp infrastructure/grafana-provisioning/datasources/prometheus.yml /etc/grafana/provisioning/datasources/
    sudo chown grafana:grafana /etc/grafana/provisioning/datasources/prometheus.yml
    echo "Grafana Prometheus datasource provisioning installed"
else
    echo -e "${YELLOW}Warning: infrastructure/grafana-provisioning/datasources/prometheus.yml not found${NC}"
fi

# Copy Grafana dashboards
DASHBOARD_COUNT=0
if compgen -G "infrastructure/grafana-dashboard-*.json" > /dev/null; then
    sudo cp infrastructure/grafana-dashboard-*.json /etc/grafana/dashboards/
    sudo chown -R grafana:grafana /etc/grafana/dashboards
    DASHBOARD_COUNT=$(ls -1 infrastructure/grafana-dashboard-*.json | wc -l)
    echo "Installed $DASHBOARD_COUNT Grafana dashboard(s)"
fi

echo -e "${GREEN}Grafana configured with $DASHBOARD_COUNT dashboards and Prometheus datasource${NC}"

# Configure Caddy
echo -e "${BLUE}Configuring Caddy web server...${NC}"

# Create Caddy log directory
sudo mkdir -p /var/log/caddy
sudo chown caddy:caddy /var/log/caddy

# Create SOAR Caddy configuration directory
sudo mkdir -p /etc/soar/caddy
sudo chown root:root /etc/soar/caddy
sudo chmod 755 /etc/soar/caddy

# Remove old monolithic config files (from pre-modular setup)
if [ -f "/etc/soar/caddy/soar-production.conf" ]; then
    echo "Removing old monolithic config: soar-production.conf"
    sudo rm -f /etc/soar/caddy/soar-production.conf
fi
if [ -f "/etc/soar/caddy/soar-staging.conf" ]; then
    echo "Removing old monolithic config: soar-staging.conf"
    sudo rm -f /etc/soar/caddy/soar-staging.conf
fi

# Install site-specific Caddy configs for this environment
echo "Installing Caddy site configs for $ENVIRONMENT environment..."
for site in "${CADDY_SITES[@]}"; do
    SITE_SOURCE="infrastructure/caddy/${site}.conf"
    SITE_DEST="/etc/soar/caddy/${site}.conf"

    if [ -f "$SITE_SOURCE" ]; then
        sudo cp "$SITE_SOURCE" "$SITE_DEST"
        sudo chown root:root "$SITE_DEST"
        sudo chmod 644 "$SITE_DEST"
        echo "  Installed ${site}.conf"
    else
        echo -e "${RED}Error: $SITE_SOURCE not found${NC}"
        exit 1
    fi
done

# Ensure main Caddyfile imports SOAR configs
MAIN_CADDYFILE="/etc/caddy/Caddyfile"
IMPORT_LINE="import /etc/soar/caddy/*"

# Create main Caddyfile if it doesn't exist
if [ ! -f "$MAIN_CADDYFILE" ]; then
    echo -e "${YELLOW}Creating main Caddyfile with import directive...${NC}"
    echo "# Main Caddyfile - imports SOAR site configurations" | sudo tee "$MAIN_CADDYFILE" > /dev/null
    echo "$IMPORT_LINE" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
    sudo chown root:root "$MAIN_CADDYFILE"
    sudo chmod 644 "$MAIN_CADDYFILE"
    echo "Created $MAIN_CADDYFILE with import directive"
else
    # Check if import directive already exists
    if ! sudo grep -qF "$IMPORT_LINE" "$MAIN_CADDYFILE"; then
        echo -e "${YELLOW}Adding import directive to existing Caddyfile...${NC}"
        # Backup existing Caddyfile
        sudo cp "$MAIN_CADDYFILE" "$MAIN_CADDYFILE.backup.$(date +%Y%m%d_%H%M%S)"
        # Add import directive at the end
        echo "" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "# Import SOAR site configurations" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "$IMPORT_LINE" | sudo tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "Added import directive to $MAIN_CADDYFILE (backup created)"
    else
        echo -e "${BLUE}Import directive already exists in $MAIN_CADDYFILE${NC}"
    fi
fi

# Validate Caddyfile syntax
if command -v caddy &> /dev/null; then
    if sudo caddy validate --config "$MAIN_CADDYFILE" 2>/dev/null; then
        echo -e "${GREEN}Caddyfile validation passed${NC}"
    else
        echo -e "${YELLOW}Warning: Caddyfile validation failed. Check configuration manually.${NC}"
    fi
fi

echo -e "${GREEN}Caddy configured for $ENVIRONMENT environment with ${#CADDY_SITES[@]} site(s)${NC}"

# Enable infrastructure services
# Note: SOAR application services are enabled by soar-deploy
echo -e "${BLUE}Enabling infrastructure services...${NC}"
sudo systemctl enable nats-server.service
sudo systemctl enable prometheus-nats-exporter.service
sudo systemctl enable photon.service
sudo systemctl enable prometheus
sudo systemctl enable grafana-server
sudo systemctl enable caddy

# Start Prometheus if not already running
if ! systemctl is-active --quiet prometheus; then
    echo -e "${BLUE}Starting Prometheus...${NC}"
    sudo systemctl start prometheus
    if systemctl is-active --quiet prometheus; then
        echo -e "${GREEN}Prometheus started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Prometheus. Check logs with: journalctl -u prometheus -n 50${NC}"
    fi
else
    echo -e "${BLUE}Prometheus is already running${NC}"
fi

# Start Grafana if not already running
if ! systemctl is-active --quiet grafana-server; then
    echo -e "${BLUE}Starting Grafana...${NC}"
    sudo systemctl start grafana-server
    if systemctl is-active --quiet grafana-server; then
        echo -e "${GREEN}Grafana started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Grafana. Check logs with: journalctl -u grafana-server -n 50${NC}"
    fi
else
    echo -e "${BLUE}Grafana is already running${NC}"
fi

# Start Caddy if not already running
if ! systemctl is-active --quiet caddy; then
    echo -e "${BLUE}Starting Caddy...${NC}"
    sudo systemctl start caddy
    if systemctl is-active --quiet caddy; then
        echo -e "${GREEN}Caddy started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Caddy. Check logs with: journalctl -u caddy -n 50${NC}"
    fi
else
    echo -e "${BLUE}Caddy is already running${NC}"
fi

# Start Photon if not already running
if ! systemctl is-active --quiet photon; then
    echo -e "${BLUE}Starting Photon...${NC}"
    sudo systemctl start photon
    if systemctl is-active --quiet photon; then
        echo -e "${GREEN}Photon started successfully${NC}"
    else
        echo -e "${YELLOW}Warning: Failed to start Photon. Check logs with: journalctl -u photon -n 50${NC}"
        echo -e "${YELLOW}Note: Photon requires geocoding data to be present in /var/lib/photon/photon_data${NC}"
    fi
else
    echo -e "${BLUE}Photon is already running${NC}"
fi

# Configure Photon OpenSearch for single-node operation
echo -e "${BLUE}Configuring Photon OpenSearch replica settings...${NC}"

# Wait for Photon OpenSearch to be ready (max 60 seconds)
PHOTON_READY=false
for i in {1..12}; do
    if curl -s -f "http://127.0.0.1:9201/_cluster/health" >/dev/null 2>&1; then
        PHOTON_READY=true
        break
    fi
    echo "Waiting for Photon OpenSearch to be ready... ($i/12)"
    sleep 5
done

if [ "$PHOTON_READY" = true ]; then
    # Set cluster default to 0 replicas for single-node operation
    echo "Setting cluster default number_of_replicas to 0..."
    curl -s -X PUT "http://127.0.0.1:9201/_cluster/settings" \
        -H 'Content-Type: application/json' \
        -d '{"persistent":{"cluster.default_number_of_replicas":0}}' >/dev/null 2>&1

    # Update existing photon index if it exists
    if curl -s -f "http://127.0.0.1:9201/photon" >/dev/null 2>&1; then
        echo "Updating existing photon index to 0 replicas..."
        curl -s -X PUT "http://127.0.0.1:9201/photon/_settings" \
            -H 'Content-Type: application/json' \
            -d '{"index":{"number_of_replicas":0}}' >/dev/null 2>&1
    fi

    echo -e "${GREEN}Photon OpenSearch configured for single-node operation${NC}"
else
    echo -e "${YELLOW}Warning: Photon OpenSearch not ready, skipping replica configuration${NC}"
    echo -e "${YELLOW}You may need to manually configure replicas. See infrastructure/DEPLOYMENT.md${NC}"
fi

# Create necessary directories
echo -e "${BLUE}Creating directories...${NC}"
sudo mkdir -p /var/soar/logs
sudo mkdir -p /var/soar/archive
sudo mkdir -p /var/soar/elevation
sudo mkdir -p /etc/soar
sudo mkdir -p /var/lib/nats/jetstream
sudo mkdir -p /var/lib/soar/backup-temp

# Set ownership for soar user
echo -e "${BLUE}Setting ownership for soar user...${NC}"
sudo chown -R soar:soar /var/soar
sudo chown -R soar:soar /var/soar/archive
sudo chown soar:soar /home/soar
sudo chmod 755 /home/soar

# Set ownership for backup temp directory (used by postgres user)
echo -e "${BLUE}Setting ownership for backup temp directory...${NC}"
sudo chown -R postgres:postgres /var/lib/soar/backup-temp
sudo chmod 750 /var/lib/soar/backup-temp

# Download elevation data with rclone
echo -e "${BLUE}Setting up elevation data...${NC}"

# Check if rclone is installed
if ! command -v rclone &> /dev/null; then
    echo "Installing rclone..."
    sudo apt-get update
    sudo apt-get install -y rclone
fi

# Download elevation tiles
if command -v rclone &> /dev/null; then
    echo -e "${BLUE}Downloading elevation tiles from S3 (this may take some time)...${NC}"
    echo -e "${YELLOW}Note: This will download ~50GB+ of worldwide elevation data${NC}"
    echo -e "${YELLOW}Using --size-only to skip files that already match${NC}"

    # Download with progress, using --size-only to skip matching files without checksumming
    # This allows resuming interrupted downloads efficiently
    sudo rclone copy --progress --size-only \
        :s3,provider=AWS,anonymous=true,region=us-east-1:elevation-tiles-prod/skadi \
        /var/soar/elevation

    # Set ownership
    sudo chown -R soar:soar /var/soar/elevation

    echo -e "${GREEN}Elevation data download complete${NC}"
else
    echo -e "${YELLOW}Warning: rclone not available. Skipping elevation data download.${NC}"
    echo -e "${YELLOW}You will need to download elevation data manually to /var/soar/elevation${NC}"
    echo -e "${YELLOW}See infrastructure/DEPLOYMENT.md for instructions${NC}"
fi

# Set ownership for NATS JetStream storage
echo -e "${BLUE}Setting ownership for NATS JetStream storage...${NC}"
sudo chown -R daemon:daemon /var/lib/nats/jetstream
echo -e "${GREEN}NATS JetStream storage configured${NC}"

# Configure PostgreSQL authentication
echo -e "${BLUE}Configuring PostgreSQL authentication...${NC}"

# Determine pg_hba.conf location
PG_HBA_CONF="/etc/postgresql/18/main/pg_hba.conf"
PG_CONF_DIR="/etc/postgresql/18/main"

if [ ! -f "$PG_HBA_CONF" ]; then
    echo -e "${RED}Error: pg_hba.conf not found at $PG_HBA_CONF${NC}"
    exit 1
fi

# Backup pg_hba.conf
echo "Backing up pg_hba.conf..."
sudo cp "$PG_HBA_CONF" "$PG_HBA_CONF.backup.$(date +%Y%m%d_%H%M%S)"

# Check if trust authentication is already configured for soar user
NEEDS_RELOAD=false

if ! grep -q "^local.*soar.*soar.*trust" "$PG_HBA_CONF"; then
    echo "Adding Unix socket trust authentication for soar user..."
    sudo sed -i "/^# \"local\" is for Unix domain socket connections only/a local   soar            soar                                    trust" "$PG_HBA_CONF"
    NEEDS_RELOAD=true
fi

# Only add TCP trust entry for the current environment's database
if ! grep -q "^host.*${DB_NAME}.*soar.*127.0.0.1/32.*trust" "$PG_HBA_CONF"; then
    echo "Adding TCP localhost trust authentication for soar user to ${DB_NAME} database..."
    sudo sed -i "/^# IPv4 local connections:/a host    ${DB_NAME}      soar            127.0.0.1/32            trust" "$PG_HBA_CONF"
    NEEDS_RELOAD=true
fi

if [ "$NEEDS_RELOAD" = true ]; then
    echo "Reloading PostgreSQL configuration..."
    sudo systemctl reload postgresql
    echo -e "${GREEN}PostgreSQL authentication configured for trust on local connections${NC}"
else
    echo -e "${BLUE}PostgreSQL authentication already correctly configured${NC}"
fi

# Create PostgreSQL databases and enable extensions
echo -e "${BLUE}Creating PostgreSQL database: $DB_NAME...${NC}"

# Create soar database user if it doesn't exist (without password)
sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'soar'" | grep -q 1 || \
    sudo -u postgres psql -c "CREATE USER soar;"

echo -e "${GREEN}PostgreSQL 'soar' user configured with trust authentication${NC}"
echo

# Create environment-specific database
if sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
    echo -e "${BLUE}Database '$DB_NAME' already exists${NC}"
else
    echo "Creating '$DB_NAME' database..."
    sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER soar;"
    echo -e "${GREEN}Database '$DB_NAME' created${NC}"
fi

# Enable PostGIS extension on database
echo -e "${BLUE}Enabling PostGIS extension on '$DB_NAME' database...${NC}"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE EXTENSION IF NOT EXISTS postgis;"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE EXTENSION IF NOT EXISTS postgis_topology;"
echo -e "${GREEN}PostGIS enabled on '$DB_NAME' database${NC}"

# Enable pg_partman extension on database
echo -e "${BLUE}Enabling pg_partman extension on '$DB_NAME' database...${NC}"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE SCHEMA IF NOT EXISTS partman;"
sudo -u postgres psql -d "$DB_NAME" -c "CREATE EXTENSION IF NOT EXISTS pg_partman SCHEMA partman;"
echo -e "${GREEN}pg_partman enabled on '$DB_NAME' database${NC}"

echo -e "${GREEN}Database setup complete!${NC}"
echo

echo -e "${GREEN}Server provisioning complete for $ENVIRONMENT environment!${NC}"
echo
echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${YELLOW}IMPORTANT: Manual Configuration Steps Required${NC}"
echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
echo
echo -e "${YELLOW}1. Configure environment variables:${NC}"
echo "   Create/edit $ENV_FILE and set:"
echo
echo "   DATABASE_URL=postgres://soar@localhost/$DB_NAME"
echo
echo -e "${YELLOW}2. Set up additional environment variables in $ENV_FILE:${NC}"
echo "   - NATS_URL (e.g., nats://localhost:4222)"
echo "   - APRS_CALLSIGN (for APRS-IS connection)"
if [[ "$ENVIRONMENT" == "production" ]]; then
    echo "   - PHOTON_BASE_URL=https://photon.glider.flights"
else
    echo "   - PHOTON_BASE_URL=https://photon.glider.flights (or http://localhost:2322 for dev)"
fi
echo "   - Any other application-specific configuration"
echo
echo -e "${YELLOW}3. Run database migrations:${NC}"
echo "   cd /path/to/soar"
echo "   diesel migration run --database-url=postgres://soar@localhost/$DB_NAME"
echo
echo -e "${YELLOW}4. Deploy SOAR application:${NC}"
echo "   Run the first deployment with soar-deploy to install SOAR services"
echo "   SOAR services will be managed by soar-deploy on each deployment"
echo
echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
echo
echo -e "${YELLOW}Infrastructure service control:${NC}"
echo "  Start services:"
echo "    sudo systemctl start nats-server"
echo "    sudo systemctl start prometheus"
echo "    sudo systemctl start prometheus-nats-exporter"
echo "    sudo systemctl start grafana-server"
echo "    sudo systemctl start photon"
echo "    sudo systemctl start caddy"
echo
echo "  Check service status:"
echo "    sudo systemctl status nats-server"
echo "    sudo systemctl status prometheus"
echo "    sudo systemctl status prometheus-nats-exporter"
echo "    sudo systemctl status grafana-server"
echo "    sudo systemctl status photon"
echo "    sudo systemctl status caddy"
echo
echo -e "${YELLOW}Check infrastructure logs:${NC}"
echo "  sudo journalctl -u nats-server -f"
echo "  sudo journalctl -u prometheus -f"
echo "  sudo journalctl -u prometheus-nats-exporter -f"
echo "  sudo journalctl -u grafana-server -f"
echo "  sudo journalctl -u photon -f"
echo "  sudo journalctl -u caddy -f"
echo
echo -e "${YELLOW}Database verification:${NC}"
echo "  sudo -u postgres psql -l  # List all databases"
echo "  sudo -u postgres psql -d $DB_NAME -c '\\dx'  # List extensions in database"
echo
echo -e "${YELLOW}Elevation Data:${NC}"
echo "  Location: /var/soar/elevation"
echo "  Verify tiles: ls -lh /var/soar/elevation/"
echo "  Test a tile: gzip -t /var/soar/elevation/N45/N45E009.hgt.gz"
TILE_COUNT=$(find /var/soar/elevation -name '*.hgt.gz' 2>/dev/null | wc -l)
if [ "$TILE_COUNT" -eq 0 ]; then
    echo -e "  ${YELLOW}WARNING: No elevation tiles found!${NC}"
    echo "  rclone may have failed. See infrastructure/DEPLOYMENT.md for manual download."
else
    echo "  Tiles installed: $TILE_COUNT"
    echo "  To resume/update: Re-run provision script or use rclone command from DEPLOYMENT.md"
fi
echo
echo -e "${YELLOW}PostgreSQL Authentication:${NC}"
echo "  Local connections (Unix socket and TCP 127.0.0.1) use 'trust' authentication"
echo "  No password required for the 'soar' user on local connections"
echo "  pg_hba.conf backup saved to: $PG_HBA_CONF.backup.*"
echo
echo -e "${YELLOW}NATS JetStream:${NC}"
echo "  NATS server installed with JetStream enabled"
echo "  JetStream storage: /var/lib/nats/jetstream"
echo "  HTTP monitoring: http://localhost:8222"
echo "  Verify NATS is running: curl http://localhost:8222/varz"
echo "  Verify JetStream: curl http://localhost:8222/jsz"
echo
echo -e "${YELLOW}Prometheus:${NC}"
echo "  Configuration: /etc/prometheus/prometheus.yml"
echo "  Job configs: /etc/prometheus/jobs/*.yml (will be deployed by soar-deploy)"
echo "  Web UI: http://localhost:9090"
echo "  Verify Prometheus: curl http://localhost:9090/-/healthy"
echo "  Data storage: /var/lib/prometheus"
echo
echo -e "${YELLOW}Grafana:${NC}"
echo "  Web UI: http://localhost:3000"
echo "  Default credentials: admin / admin (you will be prompted to change on first login)"
echo "  Dashboards: $DASHBOARD_COUNT SOAR dashboards automatically installed in 'SOAR' folder"
echo "  Prometheus datasource: Automatically configured and ready to use"
echo "  Configuration: /etc/grafana/grafana.ini"
echo "  NOTE: After starting Grafana, dashboards will be immediately available"
echo
echo -e "${YELLOW}Caddy Web Server (${ENVIRONMENT^^}):${NC}"
echo "  Main configuration: /etc/caddy/Caddyfile (imports from /etc/soar/caddy/*)"
echo "  SOAR site configs directory: /etc/soar/caddy/"
echo "  Installed sites for this environment:"
for site in "${CADDY_SITES[@]}"; do
    echo "    - /etc/soar/caddy/${site}.conf"
done
echo "  Logs: /var/log/caddy/"
echo "  Verify configuration: sudo caddy validate --config /etc/caddy/Caddyfile"
echo
echo -e "${YELLOW}  NOTE: Site-based configuration (modular)${NC}"
echo "    Each site has its own config file in /etc/soar/caddy/"
echo "    Production sites: glider.flights, photon.glider.flights, grafana.glider.flights"
echo "    Staging sites: staging.glider.flights, grafana.staging.glider.flights"
echo "    Multiple environments can coexist - files are imported by main Caddyfile"
echo
echo -e "${YELLOW}  IMPORTANT - DNS Configuration Required:${NC}"
echo "    Before Caddy can serve HTTPS, configure DNS A/AAAA records:"
for site in "${CADDY_SITES[@]}"; do
    echo "      ${site} → <server-ip>"
done
echo
echo "    Caddy will automatically obtain Let's Encrypt certificates once DNS is configured."
echo "    Test configuration: caddy run --config /etc/caddy/Caddyfile --adapter caddyfile"
echo
echo -e "${YELLOW}Photon Geocoding Server:${NC}"
echo "  Local API endpoint: http://localhost:2322"
if [[ "$ENVIRONMENT" == "production" ]]; then
    echo "  Public API endpoint: https://photon.glider.flights"
fi
echo "  OpenSearch API: http://localhost:9201"
echo "  Application directory: /opt/photon"
echo "  Data directory: /var/lib/photon"
echo "  Logs: sudo journalctl -u photon -f"
echo "  Test forward geocoding: curl 'http://localhost:2322/api?q=Berlin'"
echo "  Test reverse geocoding: curl 'http://localhost:2322/reverse?lon=13.388860&lat=52.517037'"
echo "  Configuration: /etc/systemd/system/photon.service"
echo "  Documentation: docs/photon-deployment.md"
echo ""
echo "  OpenSearch Cluster Health:"
echo "    Check cluster status: curl 'http://localhost:9201/_cluster/health?pretty'"
echo "    View shards: curl 'http://localhost:9201/_cat/shards?v'"
echo "    Single-node config: number_of_replicas set to 0 (green cluster health)"
if [ -d "/var/lib/photon/photon_data" ]; then
    echo "  Status: Data installed ✓"
else
    echo "  Status: Data not installed (download manually)"
    echo "  Download data: See docs/photon-deployment.md for instructions"
fi
