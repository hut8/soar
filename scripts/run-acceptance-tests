#!/bin/bash
#
# Run E2E acceptance tests using Docker Compose
#
# This script:
# 1. Starts PostgreSQL, NATS, and SOAR containers with source mounted
# 2. Compiles Rust application with cached artifacts (first run ~10min, subsequent ~30sec)
# 3. Runs Playwright E2E tests in a container
# 4. Collects test artifacts (screenshots, reports) to web/test-results and web/playwright-report
# 5. Cleans up containers after tests complete
#
# Usage:
#   ./scripts/run-acceptance-tests

set -e  # Exit on error

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

COMPOSE_FILES="-f docker-compose.yml -f docker-compose.dev.yml"

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  SOAR E2E Acceptance Tests${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Ensure we're in the repo root
cd "$(dirname "$0")/.."

# Export user/group IDs for Docker Compose to use (prevents root-owned files)
export USER_ID=$(id -u)
export GROUP_ID=$(id -g)

# Create artifact directories if they don't exist
mkdir -p web/test-results
mkdir -p web/playwright-report

# Stop and remove any existing containers to avoid conflicts
echo -e "${YELLOW}Cleaning up any existing containers...${NC}"
docker compose ${COMPOSE_FILES} down --remove-orphans > /dev/null 2>&1 || true
# Also force remove the specific container name if it exists
docker rm -f soar-app-test > /dev/null 2>&1 || true
echo ""

echo -e "${YELLOW}[1/3] Starting services (PostgreSQL, NATS, SOAR app)...${NC}"
echo -e "${BLUE}(Source mounted with cargo cache - first compile ~10min, subsequent ~30sec)${NC}"
docker compose ${COMPOSE_FILES} up -d postgres nats soar || {
    echo -e "${RED}Failed to start services${NC}"
    exit 1
}
echo -e "${GREEN}✓ Services started${NC}"
echo ""

# Wait for services to be healthy
echo -e "${YELLOW}[2/3] Waiting for services to be healthy...${NC}"
MAX_WAIT=600  # 10 minutes for initial compile
WAITED=0
while [ $WAITED -lt $MAX_WAIT ]; do
    if docker compose ${COMPOSE_FILES} ps | grep -q "soar-app-test.*healthy"; then
        echo -e "${GREEN}✓ All services are healthy${NC}"
        break
    fi
    echo -n "."
    sleep 2
    WAITED=$((WAITED + 2))
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo -e "${RED}Services failed to become healthy within ${MAX_WAIT} seconds${NC}"
    docker compose ${COMPOSE_FILES} logs soar | tail -100
    exit 1
fi
echo ""

echo -e "${YELLOW}[3/3] Running E2E tests...${NC}"
echo ""

# Run the E2E tests in container
# Add e2e compose file to the existing compose files
E2E_COMPOSE_FILES="${COMPOSE_FILES} -f docker-compose.e2e.yml"

docker compose ${E2E_COMPOSE_FILES} run --rm e2e-tests sh -c "
    npm ci &&
    npx playwright test
" || TEST_EXIT_CODE=$?

echo ""

# Show results
if [ ${TEST_EXIT_CODE:-0} -eq 0 ]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ E2E tests passed!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
else
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ E2E tests failed${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
fi

echo ""
echo -e "${BLUE}Test artifacts:${NC}"
echo "  Results: web/test-results/"
echo "  Report:  web/playwright-report/"
echo ""
echo "To view the HTML report:"
echo "  cd web && npx playwright show-report"
echo ""

# Cleanup containers
echo -e "${YELLOW}Stopping and removing containers...${NC}"
docker compose ${COMPOSE_FILES} down
echo -e "${GREEN}✓ Cleanup complete${NC}"
echo ""

exit ${TEST_EXIT_CODE:-0}
