#!/bin/bash
#
# Run E2E acceptance tests using Docker Compose
#
# This script:
# 1. Starts PostgreSQL and NATS containers
# 2. Builds and starts the SOAR application
# 3. Runs Playwright E2E tests in a container
# 4. Collects test artifacts (screenshots, reports) to web/test-results and web/playwright-report
#
# Usage:
#   ./scripts/run-acceptance-tests [OPTIONS]
#
# Options:
#   --build       Force rebuild of containers
#   --down        Stop and remove containers after tests
#   --dev         Use development mode (mount source, cache builds)
#
# Examples:
#   ./scripts/run-acceptance-tests                    # Run tests
#   ./scripts/run-acceptance-tests --build --down     # Rebuild, run, and cleanup
#   ./scripts/run-acceptance-tests --dev              # Dev mode with cached builds

set -e  # Exit on error

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse command line options
BUILD_FLAG=""
DOWN_FLAG=false
DEV_MODE=false
COMPOSE_FILES="-f docker-compose.yml"

while [[ $# -gt 0 ]]; do
    case $1 in
        --build)
            BUILD_FLAG="--build"
            shift
            ;;
        --down)
            DOWN_FLAG=true
            shift
            ;;
        --dev)
            DEV_MODE=true
            shift
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Usage: $0 [--build] [--down] [--dev]"
            exit 1
            ;;
    esac
done

# Set compose files based on mode
if [ "$DEV_MODE" = true ]; then
    COMPOSE_FILES="-f docker-compose.yml -f docker-compose.dev.yml"
    echo -e "${BLUE}Running in development mode (source mounted, builds cached)${NC}"
    echo ""
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  SOAR E2E Acceptance Tests${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Ensure we're in the repo root
cd "$(dirname "$0")/.."

# Create artifact directories if they don't exist
mkdir -p web/test-results
mkdir -p web/playwright-report

# Stop and remove any existing containers to avoid conflicts
echo -e "${YELLOW}Cleaning up any existing containers...${NC}"
docker compose ${COMPOSE_FILES} down > /dev/null 2>&1 || true
echo ""

echo -e "${YELLOW}[1/3] Starting services (PostgreSQL, NATS, SOAR app)...${NC}"
docker compose ${COMPOSE_FILES} up -d ${BUILD_FLAG} postgres nats soar || {
    echo -e "${RED}Failed to start services${NC}"
    exit 1
}
echo -e "${GREEN}✓ Services started${NC}"
echo ""

# Wait for services to be healthy
echo -e "${YELLOW}[2/3] Waiting for services to be healthy...${NC}"
# Dev mode needs more time for initial compile (up to 10 minutes)
if [ "$DEV_MODE" = true ]; then
    MAX_WAIT=600
    echo -e "${BLUE}(Dev mode: first compile may take up to 10 minutes)${NC}"
else
    MAX_WAIT=120
fi
WAITED=0
while [ $WAITED -lt $MAX_WAIT ]; do
    if docker compose ${COMPOSE_FILES} ps | grep -q "soar-app-test.*healthy"; then
        echo -e "${GREEN}✓ All services are healthy${NC}"
        break
    fi
    echo -n "."
    sleep 2
    WAITED=$((WAITED + 2))
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo -e "${RED}Services failed to become healthy within ${MAX_WAIT} seconds${NC}"
    docker compose ${COMPOSE_FILES} logs soar | tail -100
    exit 1
fi
echo ""

echo -e "${YELLOW}[3/3] Running E2E tests...${NC}"
echo ""

# Run the E2E tests in container
# Add e2e compose file to the existing compose files
E2E_COMPOSE_FILES="${COMPOSE_FILES} -f docker-compose.e2e.yml"

docker compose ${E2E_COMPOSE_FILES} run --rm e2e-tests sh -c "
    npm ci &&
    npx playwright install --with-deps chromium &&
    npx playwright test
" || TEST_EXIT_CODE=$?

echo ""

# Show results
if [ ${TEST_EXIT_CODE:-0} -eq 0 ]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ E2E tests passed!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
else
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ E2E tests failed${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
fi

echo ""
echo -e "${BLUE}Test artifacts:${NC}"
echo "  Results: web/test-results/"
echo "  Report:  web/playwright-report/"
echo ""
echo "To view the HTML report:"
echo "  cd web && npx playwright show-report"
echo ""

# Cleanup if requested
if [ "$DOWN_FLAG" = true ]; then
    echo -e "${YELLOW}Stopping and removing containers...${NC}"
    docker compose ${COMPOSE_FILES} down
    echo -e "${GREEN}✓ Cleanup complete${NC}"
fi

exit ${TEST_EXIT_CODE:-0}
