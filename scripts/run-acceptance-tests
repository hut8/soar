#!/bin/bash
#
# Run E2E acceptance tests using Docker Compose
#
# This script:
# 1. Starts PostgreSQL and NATS containers
# 2. Builds and starts the SOAR application
# 3. Runs Playwright E2E tests in a container
# 4. Collects test artifacts (screenshots, reports) to web/test-results and web/playwright-report
#
# Usage:
#   ./scripts/run-acceptance-tests [OPTIONS]
#
# Options:
#   --build       Force rebuild of containers
#   --down        Stop and remove containers after tests
#   --ui          Run tests in UI mode (interactive)
#   --debug       Run tests in debug mode
#   --headed      Run tests in headed mode (visible browser)
#
# Examples:
#   ./scripts/run-acceptance-tests                    # Run tests
#   ./scripts/run-acceptance-tests --build --down     # Rebuild, run, and cleanup
#   ./scripts/run-acceptance-tests --ui               # Run in interactive UI mode

set -e  # Exit on error

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse command line options
BUILD_FLAG=""
DOWN_FLAG=false
TEST_COMMAND="npx playwright test"

while [[ $# -gt 0 ]]; do
    case $1 in
        --build)
            BUILD_FLAG="--build"
            shift
            ;;
        --down)
            DOWN_FLAG=true
            shift
            ;;
        --ui)
            TEST_COMMAND="npx playwright test --ui"
            shift
            ;;
        --debug)
            TEST_COMMAND="npx playwright test --debug"
            shift
            ;;
        --headed)
            TEST_COMMAND="npx playwright test --headed"
            shift
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Usage: $0 [--build] [--down] [--ui] [--debug] [--headed]"
            exit 1
            ;;
    esac
done

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  SOAR E2E Acceptance Tests${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Ensure we're in the repo root
cd "$(dirname "$0")/.."

# Create artifact directories if they don't exist
mkdir -p web/test-results
mkdir -p web/playwright-report

echo -e "${YELLOW}[1/3] Starting services (PostgreSQL, NATS, SOAR app)...${NC}"
docker-compose up -d ${BUILD_FLAG} postgres nats app || {
    echo -e "${RED}Failed to start services${NC}"
    exit 1
}
echo -e "${GREEN}✓ Services started${NC}"
echo ""

# Wait for services to be healthy
echo -e "${YELLOW}[2/3] Waiting for services to be healthy...${NC}"
MAX_WAIT=60
WAITED=0
while [ $WAITED -lt $MAX_WAIT ]; do
    if docker-compose ps | grep -q "app.*healthy"; then
        echo -e "${GREEN}✓ All services are healthy${NC}"
        break
    fi
    echo -n "."
    sleep 2
    WAITED=$((WAITED + 2))
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo -e "${RED}Services failed to become healthy within ${MAX_WAIT} seconds${NC}"
    docker-compose logs app
    exit 1
fi
echo ""

echo -e "${YELLOW}[3/3] Running E2E tests...${NC}"
echo -e "${BLUE}Test command: ${TEST_COMMAND}${NC}"
echo ""

# Run the E2E tests
# Update the command in docker-compose.e2e.yml to use the custom test command
COMPOSE_FILES="-f docker-compose.yml -f docker-compose.e2e.yml"

# If using UI/debug/headed mode, we need to run tests on the host instead of in a container
if [[ "$TEST_COMMAND" == *"--ui"* ]] || [[ "$TEST_COMMAND" == *"--debug"* ]] || [[ "$TEST_COMMAND" == *"--headed"* ]]; then
    echo -e "${YELLOW}Running tests on host machine (interactive mode)...${NC}"
    export PLAYWRIGHT_BASE_URL="http://localhost:61226"
    cd web
    $TEST_COMMAND
    TEST_EXIT_CODE=$?
    cd ..
else
    # Run in container for CI-style execution
    docker-compose ${COMPOSE_FILES} run --rm e2e-tests sh -c "
        npm ci &&
        npx playwright install --with-deps chromium &&
        ${TEST_COMMAND}
    " || TEST_EXIT_CODE=$?
fi

echo ""

# Show results
if [ ${TEST_EXIT_CODE:-0} -eq 0 ]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ E2E tests passed!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
else
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ E2E tests failed${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
fi

echo ""
echo -e "${BLUE}Test artifacts:${NC}"
echo "  Results: web/test-results/"
echo "  Report:  web/playwright-report/"
echo ""
echo "To view the HTML report:"
echo "  cd web && npx playwright show-report"
echo ""

# Cleanup if requested
if [ "$DOWN_FLAG" = true ]; then
    echo -e "${YELLOW}Stopping and removing containers...${NC}"
    docker-compose down
    echo -e "${GREEN}✓ Cleanup complete${NC}"
fi

exit ${TEST_EXIT_CODE:-0}
