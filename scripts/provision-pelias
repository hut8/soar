#!/bin/bash
# SOAR Pelias Geocoding Service Provisioning Script
#
# This script provisions a Pelias geocoding server for SOAR by:
# - Installing OpenSearch 2.x with required plugins
# - Downloading and importing Who's on First data (city-level)
# - Setting up Pelias API and PIP services (systemd, not Docker)
# - Installing and configuring Caddy reverse proxy
#
# Usage:
#   sudo ./provision-pelias
#
# Note: This script uses Docker temporarily for data import only.
#       Production services run via systemd.

set -e
set -u
set -o pipefail
set -x

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root (use sudo)${NC}"
   exit 1
fi

# Generate or load OpenSearch admin password
OPENSEARCH_PASSWORD_FILE="/etc/opensearch/.admin_password"
PASSWORD_NEEDS_SAVING=false

if [ -f "$OPENSEARCH_PASSWORD_FILE" ]; then
    echo -e "${BLUE}Using existing OpenSearch admin password from $OPENSEARCH_PASSWORD_FILE${NC}"
    OPENSEARCH_INITIAL_ADMIN_PASSWORD=$(cat "$OPENSEARCH_PASSWORD_FILE")
else
    echo -e "${BLUE}Generating secure password for OpenSearch admin user...${NC}"
    # Temporarily disable pipefail to avoid SIGPIPE error from tr | head
    set +o pipefail
    OPENSEARCH_INITIAL_ADMIN_PASSWORD=$(LC_ALL=C tr -dc 'A-Za-z0-9!@#$%^&*()_+=-' < /dev/urandom | head -c 32)
    set -o pipefail
    # Ensure password meets complexity requirements by adding one of each required character
    OPENSEARCH_INITIAL_ADMIN_PASSWORD="Aa1!${OPENSEARCH_INITIAL_ADMIN_PASSWORD}"
    PASSWORD_NEEDS_SAVING=true
    echo -e "${BLUE}Password will be saved after OpenSearch installation${NC}"
fi
export OPENSEARCH_INITIAL_ADMIN_PASSWORD

echo -e "${GREEN}Provisioning Pelias geocoding server with OpenSearch...${NC}"

# Detect OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
else
    echo -e "${RED}Error: Cannot detect OS. /etc/os-release not found.${NC}"
    exit 1
fi

echo -e "${BLUE}Detected OS: $OS${NC}"

# Check if OS is Debian or Ubuntu
if [[ "$OS" != "ubuntu" ]] && [[ "$OS" != "debian" ]]; then
    echo -e "${RED}Error: This script only supports Debian and Ubuntu.${NC}"
    exit 1
fi

# Install prerequisites
echo -e "${BLUE}Installing prerequisites...${NC}"
apt-get update
apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release gpg jq debian-keyring debian-archive-keyring

# Install OpenSearch
echo -e "${BLUE}Installing OpenSearch...${NC}"

# Add OpenSearch GPG key and repository
if [ ! -f /usr/share/keyrings/opensearch-keyring ]; then
    curl -o- https://artifacts.opensearch.org/publickeys/opensearch.pgp | \
        gpg --dearmor --batch --yes -o /usr/share/keyrings/opensearch-keyring
fi

if [ ! -f /etc/apt/sources.list.d/opensearch-2.x.list ]; then
    echo "deb [signed-by=/usr/share/keyrings/opensearch-keyring] https://artifacts.opensearch.org/releases/bundle/opensearch/2.x/apt stable main" | \
        tee /etc/apt/sources.list.d/opensearch-2.x.list
fi

apt-get update
apt-get install -y opensearch

# Save the admin password file if it was newly generated
if [ "$PASSWORD_NEEDS_SAVING" = true ]; then
    echo -e "${BLUE}Saving OpenSearch admin password to: $OPENSEARCH_PASSWORD_FILE${NC}"
    mkdir -p /etc/opensearch
    echo "$OPENSEARCH_INITIAL_ADMIN_PASSWORD" > "$OPENSEARCH_PASSWORD_FILE"
    chmod 600 "$OPENSEARCH_PASSWORD_FILE"
    echo -e "${GREEN}OpenSearch admin password saved${NC}"
fi

# Install ICU plugin if not already installed
if /usr/share/opensearch/bin/opensearch-plugin list | grep -q analysis-icu; then
    echo -e "${BLUE}ICU analysis plugin already installed${NC}"
else
    echo -e "${BLUE}Installing ICU analysis plugin...${NC}"
    /usr/share/opensearch/bin/opensearch-plugin install analysis-icu --batch
fi

# Add current user and soar user to opensearch group for access to logs and config
echo -e "${BLUE}Adding users to opensearch group...${NC}"
CURRENT_USER="${SUDO_USER:-$USER}"
if id "$CURRENT_USER" &>/dev/null; then
    usermod -a -G opensearch "$CURRENT_USER"
    echo -e "${GREEN}Added $CURRENT_USER to opensearch group${NC}"
fi
if id soar &>/dev/null; then
    usermod -a -G opensearch soar
    echo -e "${GREEN}Added soar user to opensearch group${NC}"
fi

# Configure for Pelias
if ! grep -q "# Pelias configuration" /etc/opensearch/opensearch.yml 2>/dev/null; then
    echo -e "${BLUE}Adding Pelias configuration to opensearch.yml...${NC}"
    cat >> /etc/opensearch/opensearch.yml <<EOF

# Pelias configuration
discovery.type: single-node
indices.query.bool.max_clause_count: 4096

# Network configuration - HTTP only
network.host: 0.0.0.0
http.port: 9200

# Disable security plugin completely (no HTTPS, no authentication)
plugins.security.disabled: true
plugins.security.ssl.http.enabled: false
plugins.security.ssl.transport.enabled: false
EOF
else
    echo -e "${BLUE}Pelias configuration already exists in opensearch.yml${NC}"
fi

# Set JVM heap size (8GB - adjust based on RAM)
mkdir -p /etc/opensearch/jvm.options.d
cat > /etc/opensearch/jvm.options.d/heap.options <<EOF
-Xms8g
-Xmx8g
EOF

# Enable and start
systemctl daemon-reload
systemctl enable opensearch
systemctl start opensearch

echo -e "${GREEN}OpenSearch installed and started${NC}"

# Wait for search engine to be ready
echo -e "${BLUE}Waiting for search engine to be ready...${NC}"
for i in {1..30}; do
    if curl -s http://localhost:9200 > /dev/null 2>&1; then
        echo -e "${GREEN}Search engine is ready${NC}"
        break
    fi
    if [ $i -eq 30 ]; then
        echo -e "${RED}Error: Search engine failed to start${NC}"
        exit 1
    fi
    sleep 2
done

# Install Docker (for data import tools only)
if ! command -v docker &> /dev/null; then
    echo -e "${BLUE}Installing Docker...${NC}"

    # Add Docker GPG key and repository
    curl -fsSL https://download.docker.com/linux/$OS/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/$OS $(lsb_release -cs) stable" | \
        tee /etc/apt/sources.list.d/docker.list > /dev/null

    apt-get update
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

    # Enable and start Docker daemon
    systemctl enable docker
    systemctl start docker

    echo -e "${GREEN}Docker installed and started${NC}"
else
    echo -e "${BLUE}Docker already installed${NC}"
fi

# Ensure Docker daemon is running
if ! systemctl is-active --quiet docker; then
    echo -e "${BLUE}Starting Docker daemon...${NC}"
    systemctl start docker
fi

# Wait for Docker to be ready
echo -e "${BLUE}Waiting for Docker to be ready...${NC}"
for i in {1..10}; do
    if docker info > /dev/null 2>&1; then
        echo -e "${GREEN}Docker is ready${NC}"
        break
    fi
    if [ $i -eq 10 ]; then
        echo -e "${RED}Error: Docker failed to start${NC}"
        exit 1
    fi
    sleep 2
done

# Install Node.js 20.x LTS (for Pelias services)
if ! command -v node &> /dev/null; then
    echo -e "${BLUE}Installing Node.js 20.x LTS...${NC}"

    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs

    echo -e "${GREEN}Node.js $(node --version) installed${NC}"
else
    echo -e "${BLUE}Node.js $(node --version) already installed${NC}"
fi

# Create pelias user if it doesn't exist
if ! id "pelias" &>/dev/null; then
    echo -e "${BLUE}Creating 'pelias' system user...${NC}"
    useradd --system --user-group --create-home --home-dir /opt/pelias --shell /bin/bash pelias
    echo -e "${GREEN}'pelias' user created${NC}"
else
    echo -e "${BLUE}'pelias' user already exists${NC}"
fi

# Add pelias user to docker group for Docker access
if ! groups pelias | grep -q docker; then
    echo -e "${BLUE}Adding pelias user to docker group...${NC}"
    usermod -a -G docker pelias
    echo -e "${GREEN}pelias user added to docker group${NC}"
else
    echo -e "${BLUE}pelias user already in docker group${NC}"
fi

# Create Pelias directories
echo -e "${BLUE}Creating Pelias directory structure...${NC}"
mkdir -p /opt/pelias/docker
mkdir -p /opt/pelias/api
mkdir -p /opt/pelias/pip
mkdir -p /opt/pelias/docker/data/whosonfirst
chown -R pelias:pelias /opt/pelias

# Clone Pelias docker repository (for import tools)
if [ ! -d /opt/pelias/docker/.git ]; then
    echo -e "${BLUE}Cloning Pelias docker repository...${NC}"
    sudo -u pelias git clone https://github.com/pelias/docker.git /opt/pelias/docker
else
    echo -e "${BLUE}Pelias docker repository already exists${NC}"
fi

# Create pelias.json configuration
echo -e "${BLUE}Creating pelias.json configuration...${NC}"
cat > /opt/pelias/docker/pelias.json <<EOF
{
  "logger": {
    "level": "info",
    "timestamp": true
  },
  "esclient": {
    "hosts": [
      {
        "protocol": "http",
        "host": "172.17.0.1",
        "port": 9200
      }
    ]
  },
  "elasticsearch": {
    "settings": {
      "index": {
        "refresh_interval": "30s",
        "number_of_replicas": "0",
        "number_of_shards": "3"
      }
    }
  },
  "api": {
    "version": "1.0",
    "indexName": "pelias",
    "host": "0.0.0.0",
    "port": 4000,
    "services": {
      "pip": {
        "url": "http://localhost:4200"
      }
    }
  },
  "imports": {
    "adminLookup": {
      "enabled": true
    },
    "whosonfirst": {
      "datapath": "/data/whosonfirst"
    }
  }
}
EOF

chown pelias:pelias /opt/pelias/docker/pelias.json

# Create .env file for Docker
cat > /opt/pelias/docker/.env <<EOF
DATA_DIR=/opt/pelias/docker/data
EOF

chown pelias:pelias /opt/pelias/docker/.env

# Download Who's on First data
cd /opt/pelias/docker
if [ -d "/opt/pelias/docker/data/whosonfirst" ] && [ "$(find /opt/pelias/docker/data/whosonfirst -type f -name '*.geojson' 2>/dev/null | wc -l)" -gt 100 ]; then
    echo -e "${BLUE}Who's on First data already downloaded (skipping)${NC}"
else
    echo -e "${BLUE}Downloading Who's on First data (this will take ~30 minutes and use ~70GB)...${NC}"
    sudo -u pelias docker compose run --rm whosonfirst npm run download
fi

# Create Pelias index
if curl -s "http://localhost:9200/pelias" | grep -q "pelias"; then
    echo -e "${BLUE}Pelias index already exists (skipping creation)${NC}"
else
    echo -e "${BLUE}Creating Pelias index in OpenSearch...${NC}"
    sudo -u pelias docker compose run --rm schema npm run create_index
fi

# Import Who's on First data
DOC_COUNT=$(curl -s "http://localhost:9200/pelias/_count" | jq -r '.count // 0' 2>/dev/null || echo "0")
if [ "$DOC_COUNT" -gt 100000 ]; then
    echo -e "${BLUE}Who's on First data already imported ($DOC_COUNT documents, skipping)${NC}"
else
    echo -e "${BLUE}Importing Who's on First data (this will take ~20-30 minutes)...${NC}"
    sudo -u pelias docker compose run --rm whosonfirst npm start
    echo -e "${GREEN}Data import complete${NC}"
fi

# Clone and install Pelias API
if [ ! -d /opt/pelias/api/.git ]; then
    echo -e "${BLUE}Cloning Pelias API repository...${NC}"
    sudo -u pelias git clone https://github.com/pelias/api.git /opt/pelias/api
    cd /opt/pelias/api
    sudo -u pelias npm install --production
else
    echo -e "${BLUE}Pelias API already exists${NC}"
fi

# Clone and install Pelias PIP service
if [ ! -d /opt/pelias/pip/.git ]; then
    echo -e "${BLUE}Cloning Pelias PIP service repository...${NC}"
    sudo -u pelias git clone https://github.com/pelias/pip-service.git /opt/pelias/pip
    cd /opt/pelias/pip
    sudo -u pelias npm install --production
else
    echo -e "${BLUE}Pelias PIP service already exists${NC}"
fi

# Copy pelias.json to API and PIP directories
cp /opt/pelias/docker/pelias.json /opt/pelias/api/pelias.json
cp /opt/pelias/docker/pelias.json /opt/pelias/pip/pelias.json
chown pelias:pelias /opt/pelias/api/pelias.json /opt/pelias/pip/pelias.json

# Update pelias.json for production services (use localhost instead of Docker bridge)
sed -i 's/"host": "172.17.0.1"/"host": "127.0.0.1"/g' /opt/pelias/api/pelias.json
sed -i 's/"host": "172.17.0.1"/"host": "127.0.0.1"/g' /opt/pelias/pip/pelias.json

# Create systemd service for Pelias PIP
echo -e "${BLUE}Creating Pelias PIP systemd service...${NC}"
cat > /etc/systemd/system/pelias-pip.service <<EOF
[Unit]
Description=Pelias PIP (Point in Polygon) Service
Documentation=https://github.com/pelias/pip-service
After=network.target opensearch.service
Requires=opensearch.service

[Service]
Type=simple
User=pelias
Group=pelias
WorkingDirectory=/opt/pelias/pip
Environment="NODE_ENV=production"
Environment="PORT=4200"
Environment="PELIAS_CONFIG=/opt/pelias/pip/pelias.json"
ExecStart=/usr/bin/node /opt/pelias/pip/index.js
Restart=on-failure
RestartSec=10s
StandardOutput=journal
StandardError=journal
SyslogIdentifier=pelias-pip

# Resource limits
LimitNOFILE=65536
MemoryMax=16G

[Install]
WantedBy=multi-user.target
EOF

# Create systemd service for Pelias API
echo -e "${BLUE}Creating Pelias API systemd service...${NC}"
cat > /etc/systemd/system/pelias-api.service <<EOF
[Unit]
Description=Pelias Geocoding API Service
Documentation=https://github.com/pelias/api
After=network.target pelias-pip.service
Requires=pelias-pip.service

[Service]
Type=simple
User=pelias
Group=pelias
WorkingDirectory=/opt/pelias/api
Environment="NODE_ENV=production"
Environment="PORT=4000"
Environment="PELIAS_CONFIG=/opt/pelias/api/pelias.json"
ExecStart=/usr/bin/node /opt/pelias/api/index.js
Restart=on-failure
RestartSec=10s
StandardOutput=journal
StandardError=journal
SyslogIdentifier=pelias-api

# Resource limits
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

# Enable and start services
echo -e "${BLUE}Starting Pelias services...${NC}"
systemctl daemon-reload
systemctl enable pelias-pip.service
systemctl enable pelias-api.service
systemctl start pelias-pip.service
systemctl start pelias-api.service

# Wait for services to be ready
echo -e "${BLUE}Waiting for Pelias services to start...${NC}"
sleep 10

# Test the services
echo -e "${BLUE}Testing Pelias services...${NC}"

# Test PIP service
if curl -s http://localhost:4200/health > /dev/null 2>&1; then
    echo -e "${GREEN}Pelias PIP service is running${NC}"
else
    echo -e "${YELLOW}Warning: PIP service health check failed (may still be loading data)${NC}"
fi

# Test API service
if curl -s 'http://localhost:4000/v1/reverse?point.lat=40.7484&point.lon=-73.9857' | jq -e '.features' > /dev/null 2>&1; then
    echo -e "${GREEN}Pelias API service is running and returning results${NC}"
else
    echo -e "${YELLOW}Warning: API service test failed (PIP may still be loading data)${NC}"
    echo -e "${YELLOW}Check status with: journalctl -u pelias-pip -f${NC}"
fi

# Install Caddy
echo -e "${BLUE}Installing Caddy web server...${NC}"

# Add Caddy GPG key (Cloudsmith expects it in /usr/share/keyrings/)
mkdir -p /usr/share/keyrings
if [ ! -f /usr/share/keyrings/caddy-stable-archive-keyring.gpg ]; then
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | \
        gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
fi

# Add Caddy repository (uses signed-by pointing to /usr/share/keyrings/)
if [ ! -f /etc/apt/sources.list.d/caddy-stable.list ]; then
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | \
        tee /etc/apt/sources.list.d/caddy-stable.list
fi

apt-get update
apt-get install -y caddy

echo -e "${GREEN}Caddy installed successfully${NC}"

# Configure Caddy
echo -e "${BLUE}Configuring Caddy web server...${NC}"

# Create Caddy log directory
mkdir -p /var/log/caddy
chown caddy:caddy /var/log/caddy

# Create SOAR Caddy configuration directory
mkdir -p /etc/soar/caddy
chown root:root /etc/soar/caddy
chmod 755 /etc/soar/caddy

# Install Pelias Caddy site configs (both production and staging)
PELIAS_CADDY_SITES=("pelias.glider.flights" "pelias.staging.glider.flights")

echo "Installing Pelias Caddy site configs..."
for site in "${PELIAS_CADDY_SITES[@]}"; do
    SITE_SOURCE="infrastructure/caddy/${site}.conf"
    SITE_DEST="/etc/soar/caddy/${site}.conf"

    if [ -f "$SITE_SOURCE" ]; then
        cp "$SITE_SOURCE" "$SITE_DEST"
        chown root:root "$SITE_DEST"
        chmod 644 "$SITE_DEST"
        echo "  Installed ${site}.conf"
    else
        echo -e "${YELLOW}Warning: $SITE_SOURCE not found - skipping${NC}"
    fi
done

# Ensure main Caddyfile imports SOAR configs
MAIN_CADDYFILE="/etc/caddy/Caddyfile"
IMPORT_LINE="import /etc/soar/caddy/*"

# Create main Caddyfile if it doesn't exist
if [ ! -f "$MAIN_CADDYFILE" ]; then
    echo -e "${YELLOW}Creating main Caddyfile with import directive...${NC}"
    echo "# Main Caddyfile - imports SOAR site configurations" | tee "$MAIN_CADDYFILE" > /dev/null
    echo "$IMPORT_LINE" | tee -a "$MAIN_CADDYFILE" > /dev/null
    chown root:root "$MAIN_CADDYFILE"
    chmod 644 "$MAIN_CADDYFILE"
    echo "Created $MAIN_CADDYFILE with import directive"
else
    # Check if import directive already exists
    if ! grep -qF "$IMPORT_LINE" "$MAIN_CADDYFILE"; then
        echo -e "${YELLOW}Adding import directive to existing Caddyfile...${NC}"
        # Backup existing Caddyfile
        cp "$MAIN_CADDYFILE" "$MAIN_CADDYFILE.backup.$(date +%Y%m%d_%H%M%S)"
        # Add import directive at the end
        echo "" | tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "# Import SOAR site configurations" | tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "$IMPORT_LINE" | tee -a "$MAIN_CADDYFILE" > /dev/null
        echo "Added import directive to $MAIN_CADDYFILE (backup created)"
    else
        echo -e "${BLUE}Import directive already exists in $MAIN_CADDYFILE${NC}"
    fi
fi

# Validate Caddyfile syntax
if command -v caddy &> /dev/null; then
    if caddy validate --config "$MAIN_CADDYFILE" 2>/dev/null; then
        echo -e "${GREEN}Caddyfile validation passed${NC}"
    else
        echo -e "${YELLOW}Warning: Caddyfile validation failed. Check configuration manually.${NC}"
    fi
fi

# Reload Caddy to pick up new configuration
systemctl reload caddy

echo -e "${GREEN}Caddy configured for Pelias with ${#PELIAS_CADDY_SITES[@]} site(s)${NC}"

echo ""
echo -e "${GREEN}======================================${NC}"
echo -e "${GREEN}Pelias geocoding server setup complete!${NC}"
echo -e "${GREEN}======================================${NC}"
echo ""
echo -e "${BLUE}Services:${NC}"
echo -e "  - OpenSearch: http://localhost:9200"
echo -e "  - Pelias API: http://localhost:4000"
echo -e "  - Pelias PIP: http://localhost:4200"
echo -e "  - Caddy reverse proxy: http://localhost (configured)"
echo ""
echo -e "${BLUE}Public URLs (via Caddy):${NC}"
echo -e "  - Production: https://pelias.glider.flights"
echo -e "  - Staging: https://pelias.staging.glider.flights"
echo ""
echo -e "${BLUE}Service management:${NC}"
echo -e "  sudo systemctl status pelias-api"
echo -e "  sudo systemctl status pelias-pip"
echo -e "  sudo systemctl status opensearch"
echo -e "  sudo systemctl status caddy"
echo ""
echo -e "${BLUE}View logs:${NC}"
echo -e "  sudo journalctl -u pelias-api -f"
echo -e "  sudo journalctl -u pelias-pip -f"
echo ""
echo -e "${BLUE}Test geocoding:${NC}"
echo -e "  # Local:"
echo -e "  curl 'http://localhost:4000/v1/reverse?point.lat=40.7484&point.lon=-73.9857&layers=locality,region,country'"
echo -e ""
echo -e "  # Via Caddy (once DNS is configured):"
echo -e "  curl 'https://pelias.glider.flights/v1/reverse?point.lat=40.7484&point.lon=-73.9857'"
echo ""
echo -e "${YELLOW}Note: PIP service may take 10-20 minutes to load all locality data into memory.${NC}"
echo -e "${YELLOW}Monitor with: journalctl -u pelias-pip -f${NC}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo -e "  1. Configure DNS to point pelias.glider.flights and pelias.staging.glider.flights to this server"
echo -e "  2. Set PELIAS_BASE_URL in SOAR backend environment configuration"
echo -e "  3. Restart SOAR services to use Pelias geocoding"
echo ""
