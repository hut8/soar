#!/bin/bash
#
# wal-archive - Archive PostgreSQL WAL segments to remote SSH server
#
# This script is called by PostgreSQL via archive_command for each completed
# WAL segment (typically 16MB files). It uploads the WAL file to a remote
# SSH server using rsync and verifies the upload succeeded.
#
# Usage (called by PostgreSQL):
#   wal-archive <wal_path> <wal_filename>
#
# Arguments:
#   $1 - Full path to WAL file in pg_wal/ directory
#   $2 - WAL filename only (e.g., 000000010000000000000001)
#
# Exit codes:
#   0 - Success (WAL file archived)
#   1 - Failure (PostgreSQL will retry)
#
# Configuration:
#   Source configuration from /etc/soar/backup-env
#   SSH key at /var/soar/keys/backup_key (default)
#
# Example archive_command in postgresql.conf:
#   archive_command = '/usr/local/bin/soar-wal-archive %p %f'

set -euo pipefail

# Load configuration
if [[ ! -f /etc/soar/backup-env ]]; then
    echo "ERROR: /etc/soar/backup-env not found" >&2
    exit 1
fi

source /etc/soar/backup-env

# SSH configuration
SSH_KEY="${BACKUP_SSH_KEY:-/var/soar/keys/backup_key}"
SSH_HOST="${BACKUP_SSH_HOST:-cryptobot}"
SSH_PATH="${BACKUP_SSH_PATH:-/srv/soar-backups}"
SSH_USER="${BACKUP_SSH_USER:-root}"

# Arguments
WAL_PATH="$1"
WAL_FILE="$2"

# Validate arguments
if [[ ! -f "$WAL_PATH" ]]; then
    echo "ERROR: WAL file does not exist: $WAL_PATH" >&2
    exit 1
fi

# Validate configuration
if [[ -z "${BACKUP_SSH_HOST:-}" ]]; then
    echo "ERROR: BACKUP_SSH_HOST not set in /etc/soar/backup-env" >&2
    exit 1
fi

if [[ ! -f "$SSH_KEY" ]]; then
    echo "ERROR: SSH key not found: $SSH_KEY" >&2
    exit 1
fi

# Log directory
LOG_DIR="${BACKUP_LOG_DIR:-/var/log/soar}"
mkdir -p "$LOG_DIR"

# Function to log messages
log() {
    echo "[$(date -u +"%Y-%m-%d %H:%M:%S UTC")] WAL Archive: $*" >> "$LOG_DIR/backup.log"
}

# Destination on remote server
REMOTE_DEST="${SSH_USER}@${SSH_HOST}:${SSH_PATH}/wal/"

# SSH options for rsync
SSH_OPTS="-i $SSH_KEY -o StrictHostKeyChecking=accept-new -o BatchMode=yes"

# Upload WAL file to remote server using rsync over SSH
log "Archiving WAL segment: $WAL_FILE ($(du -h "$WAL_PATH" | cut -f1))"

if rsync -az \
    -e "ssh $SSH_OPTS" \
    "$WAL_PATH" \
    "${REMOTE_DEST}${WAL_FILE}" \
    >> "$LOG_DIR/backup.log" 2>&1; then

    # Verify upload by checking if file exists on remote server
    if ssh $SSH_OPTS "${SSH_USER}@${SSH_HOST}" \
        "test -f ${SSH_PATH}/wal/${WAL_FILE}" \
        >> "$LOG_DIR/backup.log" 2>&1; then
        log "Successfully archived WAL segment: $WAL_FILE"
        exit 0
    else
        log "ERROR: WAL segment uploaded but verification failed: $WAL_FILE"
        exit 1
    fi
else
    log "ERROR: Failed to upload WAL segment: $WAL_FILE"
    exit 1
fi
