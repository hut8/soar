#!/bin/bash
#
# wal-archive - Archive PostgreSQL WAL segments to Wasabi S3
#
# This script is called by PostgreSQL via archive_command for each completed
# WAL segment (typically 16MB files). It uploads the WAL file to Wasabi S3
# using rclone and verifies the upload succeeded.
#
# Usage (called by PostgreSQL):
#   wal-archive <wal_path> <wal_filename>
#
# Arguments:
#   $1 - Full path to WAL file in pg_wal/ directory
#   $2 - WAL filename only (e.g., 000000010000000000000001)
#
# Exit codes:
#   0 - Success (WAL file archived)
#   1 - Failure (PostgreSQL will retry)
#
# Configuration:
#   Source configuration from /etc/soar/backup-env
#   Requires rclone configured with Wasabi remote
#
# Example archive_command in postgresql.conf:
#   archive_command = '/usr/local/bin/soar-wal-archive %p %f'

set -euo pipefail

# Load configuration
if [[ ! -f /etc/soar/backup-env ]]; then
    echo "ERROR: /etc/soar/backup-env not found" >&2
    exit 1
fi

source /etc/soar/backup-env

# Rclone configuration
RCLONE_REMOTE="${BACKUP_RCLONE_REMOTE:-wasabi}"
RCLONE_BUCKET="${BACKUP_RCLONE_BUCKET:-soar-backup-prod}"
RCLONE_PATH="${BACKUP_RCLONE_PATH:-}"  # Optional prefix within bucket

# Arguments
WAL_PATH="$1"
WAL_FILE="$2"

# Validate arguments
if [[ ! -f "$WAL_PATH" ]]; then
    echo "ERROR: WAL file does not exist: $WAL_PATH" >&2
    exit 1
fi

# Validate configuration
if [[ -z "${BACKUP_RCLONE_REMOTE:-}" ]]; then
    echo "ERROR: BACKUP_RCLONE_REMOTE not set in /etc/soar/backup-env" >&2
    exit 1
fi

if [[ -z "${BACKUP_RCLONE_BUCKET:-}" ]]; then
    echo "ERROR: BACKUP_RCLONE_BUCKET not set in /etc/soar/backup-env" >&2
    exit 1
fi

# Check rclone is available
if ! command -v rclone >/dev/null 2>&1; then
    echo "ERROR: rclone not found in PATH" >&2
    exit 1
fi

# Verify rclone remote is configured
if ! rclone listremotes | grep -q "^${RCLONE_REMOTE}:$"; then
    echo "ERROR: rclone remote '${RCLONE_REMOTE}' not configured" >&2
    echo "Run: rclone config" >&2
    exit 1
fi

# Log directory
LOG_DIR="${BACKUP_LOG_DIR:-/var/log/soar}"
mkdir -p "$LOG_DIR"

# Function to log messages
log() {
    echo "[$(date -u +"%Y-%m-%d %H:%M:%S UTC")] WAL Archive: $*" >> "$LOG_DIR/backup.log"
}

# Construct rclone destination path
if [[ -n "$RCLONE_PATH" ]]; then
    REMOTE_DEST="${RCLONE_REMOTE}:${RCLONE_BUCKET}/${RCLONE_PATH}/wal/"
else
    REMOTE_DEST="${RCLONE_REMOTE}:${RCLONE_BUCKET}/wal/"
fi

# Upload WAL file to Wasabi S3 using rclone
log "Archiving WAL segment: $WAL_FILE ($(du -h "$WAL_PATH" | cut -f1))"

if rclone copyto \
    "$WAL_PATH" \
    "${REMOTE_DEST}${WAL_FILE}" \
    >> "$LOG_DIR/backup.log" 2>&1; then

    # Verify upload by checking if file exists in Wasabi S3
    if rclone ls "${REMOTE_DEST}${WAL_FILE}" \
        >> "$LOG_DIR/backup.log" 2>&1; then
        log "Successfully archived WAL segment: $WAL_FILE"
        exit 0
    else
        log "ERROR: WAL segment uploaded but verification failed: $WAL_FILE"
        exit 1
    fi
else
    log "ERROR: Failed to upload WAL segment: $WAL_FILE"
    exit 1
fi
