#!/usr/bin/env bash
#
# create-release - Simplified release script for SOAR
#
# This script creates a GitHub Release which automatically triggers:
# - Building x64 and ARM64 static binaries (via ci.yml)
# - Deploying to production (via ci.yml deploy-production job)
# - Version is derived from the git tag (no version file commits needed!)
#
# Usage:
#   ./scripts/create-release v0.1.5
#   ./scripts/create-release v0.1.5 --draft  # Create as draft
#   ./scripts/create-release v0.1.5 --notes "Custom release notes"
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
info() { echo -e "${GREEN}✓${NC} $*"; }
warn() { echo -e "${YELLOW}⚠${NC} $*"; }
error() { echo -e "${RED}✗${NC} $*"; exit 1; }

# Check if gh CLI is installed
if ! command -v gh &> /dev/null; then
    error "GitHub CLI (gh) is not installed. Install it from https://cli.github.com/"
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error "Not in a git repository"
fi

# Check if on main branch
current_branch=$(git branch --show-current)
if [ "$current_branch" != "main" ]; then
    error "Must be on main branch to create release (currently on: $current_branch)"
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    error "Uncommitted changes detected. Commit or stash changes before creating release."
fi

# Pull latest changes
info "Pulling latest changes from origin..."
git pull origin main

# Parse arguments
VERSION=""
DRAFT_FLAG=""
NOTES_FLAG=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --draft)
            DRAFT_FLAG="--draft"
            shift
            ;;
        --notes)
            NOTES_FLAG="--notes \"$2\""
            shift 2
            ;;
        v*)
            VERSION="$1"
            shift
            ;;
        *)
            error "Unknown argument: $1\n\nUsage: $0 VERSION [--draft] [--notes \"Release notes\"]"
            ;;
    esac
done

# Validate version argument
if [ -z "$VERSION" ]; then
    error "Version argument required\n\nUsage: $0 VERSION [--draft] [--notes \"Release notes\"]\n\nExample: $0 v0.1.5"
fi

# Validate version format (must start with 'v' and follow semver)
if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
    error "Invalid version format: $VERSION\n\nMust follow semver with 'v' prefix (e.g., v0.1.5, v1.0.0-beta.1)"
fi

# Check if tag already exists locally or remotely
if git rev-parse "$VERSION" >/dev/null 2>&1; then
    error "Tag $VERSION already exists locally"
fi

if git ls-remote --tags origin | grep -q "refs/tags/$VERSION"; then
    error "Tag $VERSION already exists on remote"
fi

# Confirm with user
echo ""
echo "Creating release:"
echo "  Version: $VERSION"
echo "  Branch: $current_branch"
echo "  Commit: $(git rev-parse --short HEAD)"
[ -n "$DRAFT_FLAG" ] && echo "  Draft: yes"
[ -n "$NOTES_FLAG" ] && echo "  Custom notes: yes"
echo ""
read -p "Proceed with release? (y/N) " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    warn "Release cancelled"
    exit 0
fi

# Create GitHub Release
info "Creating GitHub Release for $VERSION..."

# Build gh command
GH_CMD="gh release create \"$VERSION\""
[ -n "$DRAFT_FLAG" ] && GH_CMD="$GH_CMD $DRAFT_FLAG"
if [ -n "$NOTES_FLAG" ]; then
    GH_CMD="$GH_CMD $NOTES_FLAG"
else
    GH_CMD="$GH_CMD --generate-notes"
fi

# Execute the command
if eval "$GH_CMD"; then
    info "Successfully created release $VERSION"
    echo ""
    info "The GitHub Actions workflow will now:"
    echo "  1. Build x64 and ARM64 static binaries (ci.yml)"
    echo "  2. Run all tests and security audits"
    echo "  3. Deploy to production (ci.yml deploy-production job)"
    echo ""
    info "Monitor progress: https://github.com/$(gh repo view --json nameWithOwner -q .nameWithOwner)/actions"
    info "View release: $(gh release view "$VERSION" --json url -q .url)"
else
    error "Failed to create release"
fi
