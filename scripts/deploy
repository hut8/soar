#!/bin/bash
#
# SOAR Local Deployment Script
#
# Deploys SOAR locally by creating a deployment bundle and invoking soar-deploy.
# This script mimics the GitHub Actions deployment workflow for local use.
#
# Usage:
#   ./scripts/deploy staging     # Deploy to staging environment
#   ./scripts/deploy production  # Deploy to production environment
#
# Prerequisites:
#   - Script must be run from the project root directory
#   - User must have sudo access
#
# Note: If no binary exists, the script will automatically run 'cargo build --release'
#
# What this script does:
#   1. Creates a deployment bundle with binary and infrastructure files
#   2. Installs soar-deploy to /usr/local/bin/soar-deploy
#   3. Invokes soar-deploy with the specified environment
#

set -e
set -u
set -o pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "\n${BLUE}==>${NC} ${BLUE}$1${NC}\n"
}

# Cleanup function
cleanup() {
    if [ -n "${TEMP_DIR:-}" ] && [ -d "$TEMP_DIR" ]; then
        log_info "Cleaning up temporary directory: $TEMP_DIR"
        rm -rf "$TEMP_DIR"
    fi
}

trap cleanup EXIT

# Check arguments
if [ $# -lt 1 ]; then
    log_error "Usage: $0 <staging|production>"
    exit 1
fi

ENVIRONMENT="$1"

# Validate environment
if [ "$ENVIRONMENT" != "staging" ] && [ "$ENVIRONMENT" != "production" ]; then
    log_error "Invalid environment: $ENVIRONMENT (must be 'staging' or 'production')"
    exit 1
fi

# Check if we're in the project root
if [ ! -f "Cargo.toml" ] || [ ! -d "web" ]; then
    log_error "This script must be run from the project root directory"
    exit 1
fi

# Find the binary - prefer release build, fall back to debug, or build if needed
if [ -f "target/release/soar" ]; then
    BINARY_PATH="target/release/soar"
    log_info "Using release binary: $BINARY_PATH"
elif [ -f "target/debug/soar" ]; then
    BINARY_PATH="target/debug/soar"
    log_warn "Using debug binary: $BINARY_PATH (consider building release for production)"
else
    log_step "Building release binary"
    log_info "No binary found, running 'cargo build --release'..."
    cargo build --release
    BINARY_PATH="target/release/soar"
    log_info "Build complete: $BINARY_PATH"
fi

# Get version info
if git describe --tags --always >/dev/null 2>&1; then
    VERSION=$(git describe --tags --always --dirty 2>/dev/null)
else
    VERSION=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
fi
log_info "Version: $VERSION"

# Prepare deployment package
log_step "Preparing deployment package for $ENVIRONMENT"

TIMESTAMP=$(date +%Y%m%d%H%M%S)
TEMP_DIR=$(mktemp -d)
DEPLOY_PKG="$TEMP_DIR/deploy-pkg"
mkdir -p "$DEPLOY_PKG"

log_info "Creating deployment package in: $DEPLOY_PKG"

# Copy binary
cp "$BINARY_PATH" "$DEPLOY_PKG/soar"
chmod +x "$DEPLOY_PKG/soar"

# Copy deployment script
if [ -f "infrastructure/soar-deploy" ]; then
    cp infrastructure/soar-deploy "$DEPLOY_PKG/"
else
    log_error "infrastructure/soar-deploy not found"
    exit 1
fi

# Copy service files from infrastructure/systemd
if [ -d "infrastructure/systemd" ]; then
    cp infrastructure/systemd/*.service "$DEPLOY_PKG/" 2>/dev/null || log_warn "No service files found"
    cp infrastructure/systemd/*.timer "$DEPLOY_PKG/" 2>/dev/null || log_warn "No timer files found"
    cp infrastructure/systemd/*.target "$DEPLOY_PKG/" 2>/dev/null || log_warn "No target files found"

    # Copy systemd template files (used for Grafana SMTP configuration)
    if ls infrastructure/systemd/*.template 1>/dev/null 2>&1; then
        mkdir -p "$DEPLOY_PKG/systemd"
        cp infrastructure/systemd/*.template "$DEPLOY_PKG/systemd/"
        log_info "Systemd template files included"
    fi
    log_info "Systemd service/timer/target files included"
else
    log_warn "infrastructure/systemd directory not found"
fi

# Copy Prometheus job configuration files
if [ -d "infrastructure/prometheus-jobs" ]; then
    cp -r infrastructure/prometheus-jobs "$DEPLOY_PKG/"
    log_info "Prometheus job files included"
fi

# Copy Grafana provisioning configuration
if [ -d "infrastructure/grafana-provisioning" ]; then
    cp -r infrastructure/grafana-provisioning "$DEPLOY_PKG/"
    log_info "Grafana provisioning configuration included"
fi

# Copy Grafana dashboard files
if compgen -G "infrastructure/grafana-dashboard-*.json" >/dev/null; then
    cp infrastructure/grafana-dashboard-*.json "$DEPLOY_PKG/"
    DASHBOARD_COUNT=$(ls -1 infrastructure/grafana-dashboard-*.json | wc -l)
    log_info "Grafana dashboards included: $DASHBOARD_COUNT"
fi

# Copy backup scripts directory
if [ -d "scripts/backup" ]; then
    mkdir -p "$DEPLOY_PKG/scripts"
    cp -r scripts/backup "$DEPLOY_PKG/scripts/"
    log_info "Backup scripts included"
fi

# Create version file
echo "$VERSION" >"$DEPLOY_PKG/VERSION"

log_info "Deployment package contents:"
ls -lh "$DEPLOY_PKG/"

# Create deployment directory
log_step "Setting up deployment directory"

DEPLOY_BASE_DIR="/tmp/soar/deploy"
DEPLOY_DIR="$DEPLOY_BASE_DIR/$TIMESTAMP"

sudo mkdir -p "$DEPLOY_DIR"
sudo cp -r "$DEPLOY_PKG"/* "$DEPLOY_DIR/"
sudo chown -R soar:soar "$DEPLOY_DIR" 2>/dev/null || sudo chown -R root:root "$DEPLOY_DIR"

log_info "Deployment package ready at: $DEPLOY_DIR"

# Install soar-deploy unconditionally
log_step "Installing soar-deploy"

sudo rm -f /usr/local/bin/soar-deploy
sudo install -m 755 -o root -g root infrastructure/soar-deploy /usr/local/bin/soar-deploy
log_info "Installed soar-deploy to /usr/local/bin/soar-deploy"

# Execute deployment
log_step "Executing deployment for $ENVIRONMENT"

log_info "Running: sudo /usr/local/bin/soar-deploy $ENVIRONMENT $DEPLOY_DIR"
sudo /usr/local/bin/soar-deploy "$ENVIRONMENT" "$DEPLOY_DIR"

log_step "Deployment completed!"
log_info "Environment: $ENVIRONMENT"
log_info "Version: $VERSION"
log_info "Timestamp: $TIMESTAMP"
