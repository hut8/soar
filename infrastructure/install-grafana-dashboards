#!/bin/bash
#
# Install Grafana Dashboards Script
#
# This script installs SOAR Grafana dashboards and provisioning configuration
# on the local server. Run this script when you need to manually update dashboards
# without doing a full deployment.
#
# Usage: sudo ./infrastructure/install-grafana-dashboards
#

set -e
set -u
set -o pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    log_error "This script must be run with sudo"
    echo "Usage: sudo $0"
    exit 1
fi

# Check if we're in the SOAR repository
if [ ! -d "infrastructure" ] || [ ! -f "infrastructure/grafana-README.md" ]; then
    log_error "This script must be run from the SOAR repository root directory"
    echo "Current directory: $(pwd)"
    exit 1
fi

log_info "Installing SOAR Grafana dashboards..."

# Check if grafana user exists
if ! id "grafana" &>/dev/null; then
    log_error "grafana user not found - is Grafana installed?"
    exit 1
fi

# Install Grafana provisioning configuration
if [ -d "infrastructure/grafana-provisioning" ]; then
    log_info "Installing Grafana provisioning configuration..."
    mkdir -p /etc/grafana/provisioning/dashboards
    cp -r infrastructure/grafana-provisioning/dashboards/*.yml /etc/grafana/provisioning/dashboards/
    chmod 644 /etc/grafana/provisioning/dashboards/*.yml
    chown -R grafana:grafana /etc/grafana/provisioning/dashboards
    log_info "Grafana provisioning configuration installed"
else
    log_warn "grafana-provisioning directory not found, skipping provisioning configuration"
fi

# Install Grafana dashboard JSON files
DASHBOARD_COUNT=0
if compgen -G "infrastructure/grafana-dashboard-*.json" > /dev/null; then
    log_info "Installing Grafana dashboard files..."
    mkdir -p /etc/grafana/dashboards
    cp infrastructure/grafana-dashboard-*.json /etc/grafana/dashboards/
    chmod 644 /etc/grafana/dashboards/*.json
    chown -R grafana:grafana /etc/grafana/dashboards
    DASHBOARD_COUNT=$(ls -1 infrastructure/grafana-dashboard-*.json | wc -l)
    log_info "Installed $DASHBOARD_COUNT Grafana dashboard(s)"
else
    log_warn "No Grafana dashboard files found, skipping dashboard installation"
fi

# List installed dashboards
if [ $DASHBOARD_COUNT -gt 0 ]; then
    log_info "Installed dashboards:"
    ls -1 /etc/grafana/dashboards/ | sed 's/^/  - /'
fi

# Restart Grafana if it's running
if systemctl is-active --quiet grafana-server; then
    log_info "Restarting Grafana to load new dashboards..."
    systemctl restart grafana-server

    # Wait a moment for Grafana to start
    sleep 2

    if systemctl is-active --quiet grafana-server; then
        log_info "Grafana restarted successfully"
    else
        log_error "Grafana failed to restart"
        log_info "Check logs with: journalctl -u grafana-server -n 50"
        exit 1
    fi
else
    log_warn "Grafana is not running, skipping restart"
    log_info "Start Grafana with: systemctl start grafana-server"
fi

log_info "${GREEN}âœ“ Grafana dashboards installed successfully!${NC}"
log_info ""
log_info "Dashboards should be available in Grafana under the 'SOAR' folder"
log_info "Grafana URL: http://localhost:3000"
