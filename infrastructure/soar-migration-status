#!/bin/bash
# SOAR Migration Status Checker
#
# Check the status of the most recent migration for an environment
#
# Usage: soar-migration-status <environment>
#   environment: staging or production

set -euo pipefail

ENVIRONMENT="${1:-staging}"
STATUS_FILE="/var/soar/migration-status/${ENVIRONMENT}.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if status file exists
if [ ! -f "$STATUS_FILE" ]; then
    echo -e "${YELLOW}No migration status found for $ENVIRONMENT${NC}"
    echo "Status file: $STATUS_FILE"
    exit 1
fi

# Read status file
STATUS_JSON=$(cat "$STATUS_FILE")

# Extract fields
STATUS=$(echo "$STATUS_JSON" | jq -r '.status // "unknown"')
TIMESTAMP=$(echo "$STATUS_JSON" | jq -r '.timestamp // "unknown"')
MESSAGE=$(echo "$STATUS_JSON" | jq -r '.message // ""')
EXIT_CODE=$(echo "$STATUS_JSON" | jq -r '.exit_code // 0')
LOG_FILE=$(echo "$STATUS_JSON" | jq -r '.log_file // ""')

# Display status with color
echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}Migration Status: $ENVIRONMENT${NC}"
echo -e "${BLUE}=========================================${NC}"
echo ""

case "$STATUS" in
    running)
        echo -e "Status:    ${YELLOW}RUNNING${NC}"
        ;;
    completed)
        echo -e "Status:    ${GREEN}COMPLETED${NC}"
        ;;
    failed)
        echo -e "Status:    ${RED}FAILED${NC}"
        ;;
    *)
        echo -e "Status:    ${YELLOW}UNKNOWN${NC}"
        ;;
esac

echo "Timestamp: $TIMESTAMP"

if [ -n "$MESSAGE" ] && [ "$MESSAGE" != "null" ]; then
    echo "Message:   $MESSAGE"
fi

if [ "$STATUS" = "failed" ]; then
    echo -e "Exit Code: ${RED}$EXIT_CODE${NC}"
fi

if [ -n "$LOG_FILE" ] && [ "$LOG_FILE" != "null" ]; then
    echo "Log File:  $LOG_FILE"
fi

echo ""

# Check systemd service status
echo -e "${BLUE}Systemd Service Status:${NC}"
if systemctl is-active --quiet "soar-migrate@${ENVIRONMENT}.service"; then
    echo -e "${YELLOW}Service is currently running${NC}"
    echo ""
    echo "To view live logs:"
    echo "  journalctl -u soar-migrate@${ENVIRONMENT} -f"
elif systemctl is-failed --quiet "soar-migrate@${ENVIRONMENT}.service"; then
    echo -e "${RED}Service failed${NC}"
    echo ""
    echo "To view failure logs:"
    echo "  journalctl -u soar-migrate@${ENVIRONMENT} -n 200"
else
    echo -e "${GREEN}Service completed${NC}"
fi

echo ""

# Show recent journal entries
echo -e "${BLUE}Recent Log Entries (last 10 lines):${NC}"
journalctl -u "soar-migrate@${ENVIRONMENT}" -n 10 --no-pager 2>/dev/null || echo "No journal entries found"

echo ""
echo -e "${BLUE}=========================================${NC}"

# Exit with appropriate code
if [ "$STATUS" = "failed" ]; then
    exit 1
elif [ "$STATUS" = "running" ]; then
    exit 2
else
    exit 0
fi
