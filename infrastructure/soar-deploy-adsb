#!/bin/bash
#
# SOAR ADS-B Deployment Script
#
# This script is executed with sudo privileges to deploy ADS-B ingester updates.
# It must be installed at /usr/local/bin/soar-deploy-adsb with permissions 755.
#
# Usage:
#   sudo /usr/local/bin/soar-deploy-adsb [production|staging] /tmp/soar/deploy/YYYYMMDDHHMMSS
#   sudo /usr/local/bin/soar-deploy-adsb /tmp/soar/deploy/YYYYMMDDHHMMSS  (defaults to production)
#
# The deployment directory should contain:
#   - soar (the binary)
#   - soar-beast-ingest.service (production) or soar-beast-ingest-staging.service (staging)
#

set -e
set -u
set -o pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Parse arguments: environment and deploy directory
# Supports both: "soar-deploy-adsb staging /path" and "soar-deploy-adsb /path" (defaults to production)
if [ $# -eq 2 ]; then
    ENVIRONMENT="$1"
    DEPLOY_DIR="$2"
elif [ $# -eq 1 ]; then
    ENVIRONMENT="production"
    DEPLOY_DIR="$1"
else
    log_error "Usage: $0 [production|staging] /tmp/soar/deploy/YYYYMMDDHHMMSS"
    log_error "   or: $0 /tmp/soar/deploy/YYYYMMDDHHMMSS  (defaults to production)"
    exit 1
fi

# Validate environment
if [ "$ENVIRONMENT" != "production" ] && [ "$ENVIRONMENT" != "staging" ]; then
    log_error "Invalid environment: $ENVIRONMENT (must be 'production' or 'staging')"
    exit 1
fi

# Verify deployment directory exists
if [ ! -d "$DEPLOY_DIR" ]; then
    log_error "Deployment directory does not exist: $DEPLOY_DIR"
    exit 1
fi

log_info "Starting SOAR ADS-B ingester deployment for $ENVIRONMENT from: $DEPLOY_DIR"

# Set environment-specific variables
if [ "$ENVIRONMENT" = "staging" ]; then
    SERVICE_SUFFIX="-staging"
    ENV_FILE="/etc/soar/env-staging"
    BINARY_PATH="/usr/local/bin/soar-staging"
    BACKUP_DIR="/home/soar/backups/staging"
    SERVICE_NAME="soar-beast-ingest-staging.service"
else
    SERVICE_SUFFIX=""
    ENV_FILE="/etc/soar/env"
    BINARY_PATH="/usr/local/bin/soar"
    BACKUP_DIR="/home/soar/backups/production"
    SERVICE_NAME="soar-beast-ingest.service"
fi

log_info "Environment: $ENVIRONMENT"
log_info "Service suffix: '$SERVICE_SUFFIX'"
log_info "Environment file: $ENV_FILE"
log_info "Binary path: $BINARY_PATH"
log_info "Service: $SERVICE_NAME"

# Verify binary exists
if [ ! -f "$DEPLOY_DIR/soar" ]; then
    log_error "Binary not found in deployment directory: $DEPLOY_DIR/soar"
    exit 1
fi

# Verify service file exists
if [ ! -f "$DEPLOY_DIR/$SERVICE_NAME" ]; then
    log_error "Service file not found in deployment directory: $DEPLOY_DIR/$SERVICE_NAME"
    exit 1
fi

# Create temporary binary directory with timestamp
TIMESTAMP=$(date +%s)
TEMP_BIN_DIR="/var/soar/bin"
TEMP_BIN_PATH="$TEMP_BIN_DIR/soar-$TIMESTAMP"

log_info "Creating temporary binary directory: $TEMP_BIN_DIR"
mkdir -p "$TEMP_BIN_DIR"
chown soar:soar "$TEMP_BIN_DIR"

# Deploy new binary to temporary location first (avoids "text file busy")
log_info "Deploying new binary to temporary location: $TEMP_BIN_PATH"
install -m 755 -o soar -g soar "$DEPLOY_DIR/soar" "$TEMP_BIN_PATH"
log_info "Binary deployed to temporary location"

# Stop the Beast ingest service
log_info "Stopping $SERVICE_NAME..."
if systemctl is-active --quiet "$SERVICE_NAME"; then
    systemctl stop "$SERVICE_NAME" || log_warn "Failed to stop $SERVICE_NAME"
    log_info "$SERVICE_NAME stopped"
else
    log_info "$SERVICE_NAME is not running"
fi

# Wait for service to fully terminate
log_info "Waiting for service to fully terminate..."
sleep 3

# Backup current binary
mkdir -p "$BACKUP_DIR"
chown soar:soar "$BACKUP_DIR"

if [ -f "$BINARY_PATH" ]; then
    BACKUP_FILE="$BACKUP_DIR/soar.backup.$(date +%s)"
    log_info "Backing up current binary to $BACKUP_FILE..."
    cp "$BINARY_PATH" "$BACKUP_FILE"
    chown soar:soar "$BACKUP_FILE"
else
    log_warn "No existing binary to backup at $BINARY_PATH"
fi

# Install new binary
log_info "Installing new binary to $BINARY_PATH..."
install -m 755 -o root -g root "$TEMP_BIN_PATH" "$BINARY_PATH"
log_info "Binary installed successfully at $BINARY_PATH"

# Clean up temporary binary
log_info "Cleaning up temporary binary: $TEMP_BIN_PATH"
rm -f "$TEMP_BIN_PATH"

# Install service file
log_info "Installing service file: $SERVICE_NAME..."
cp "$DEPLOY_DIR/$SERVICE_NAME" /etc/systemd/system/
chmod 644 "/etc/systemd/system/$SERVICE_NAME"
log_info "Service file installed"

# Reload systemd daemon
log_info "Reloading systemd daemon..."
systemctl daemon-reload

# Enable and start service
log_info "Enabling and starting $SERVICE_NAME..."
systemctl enable "$SERVICE_NAME" || log_warn "Failed to enable $SERVICE_NAME"

log_info "Starting $SERVICE_NAME..."
systemctl start "$SERVICE_NAME" || log_warn "Failed to start $SERVICE_NAME"

# Wait for service to start
log_info "Waiting for service to initialize..."
sleep 5

# Check service status
log_info "Checking service status..."
if systemctl is-active --quiet "$SERVICE_NAME"; then
    log_info "$SERVICE_NAME: ${GREEN}ACTIVE${NC}"
else
    log_error "$SERVICE_NAME: ${RED}FAILED${NC}"

    # Show recent logs for failed service
    log_info "Recent logs for $SERVICE_NAME:"
    journalctl -u "$SERVICE_NAME" --no-pager --lines=20 || true

    log_error "${RED}Deployment completed with errors. Service failed to start.${NC}"
    exit 1
fi

# Show recent logs from service
log_info "Recent logs from $SERVICE_NAME:"
journalctl -u "$SERVICE_NAME" --no-pager --lines=10 || true

# Clean up old backups (keep last 5)
log_info "Cleaning up old backups in $BACKUP_DIR (keeping last 5)..."
ls -t "$BACKUP_DIR"/soar.backup.* 2>/dev/null | tail -n +6 | xargs rm -f || true

# Clean up old deployment directories (keep last 3)
log_info "Cleaning up old deployment directories (keeping last 3)..."
ls -td /tmp/soar/deploy/* 2>/dev/null | tail -n +4 | xargs rm -rf || true

log_info "${GREEN}Deployment completed successfully!${NC}"
exit 0
