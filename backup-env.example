# SOAR Database Backup Configuration
#
# This file contains environment variables for the backup system.
# Copy this file to /etc/soar/backup-env and configure with your settings.
#
# Installation:
#   sudo mkdir -p /etc/soar
#   sudo cp backup-env.example /etc/soar/backup-env
#   sudo nano /etc/soar/backup-env  # Edit with your values
#   sudo chown postgres:postgres /etc/soar/backup-env
#   sudo chmod 600 /etc/soar/backup-env
#
#   # Ensure SSH key exists and has correct permissions
#   sudo chown postgres:postgres /var/soar/keys/backup_key
#   sudo chmod 600 /var/soar/keys/backup_key
#
# IMPORTANT: This file is a systemd EnvironmentFile - DO NOT use 'export'!
#   - Set permissions to 600 (read/write for owner only)
#   - Owner should be postgres:postgres
#   - Never commit this file to version control
#   - Format: KEY=value (no 'export', no quotes unless needed)

#------------------------------------------------------------------------------
# SSH BACKUP STORAGE CONFIGURATION
#------------------------------------------------------------------------------

# SSH server hostname or IP address (REQUIRED)
BACKUP_SSH_HOST=cryptobot

# SSH user (default: root)
BACKUP_SSH_USER=root

# Remote path on SSH server where backups will be stored
BACKUP_SSH_PATH=/srv/soar-backups

# Path to SSH private key for authentication
# Default: /var/soar/keys/backup_key
BACKUP_SSH_KEY=/var/soar/keys/backup_key

# Note: The SSH public key must be added to the authorized_keys file
# on the remote server:
#   ssh-copy-id -i /var/soar/keys/backup_key.pub root@cryptobot
# Or manually add the contents of /var/soar/keys/backup_key.pub to
# ~/.ssh/authorized_keys on the remote server

#------------------------------------------------------------------------------
# BACKUP RETENTION CONFIGURATION
#------------------------------------------------------------------------------

# How many days to keep base backups before deletion
# MUST be >= WAL_RETENTION_DAYS (WAL files are useless without a base backup!)
# Default: 30 days - ensures all WAL files can be used for recovery
# Combined with bi-weekly backups, this keeps ~2 base backups at any time
BACKUP_RETENTION_DAYS=30

# Minimum number of base backups to always keep (safety check)
# Even if backups are older than BACKUP_RETENTION_DAYS, keep at least this many
# Default: 2 (ensures we always have a recent backup for recovery)
BASE_BACKUP_MIN_COUNT=2

# WAL archive retention (for point-in-time recovery)
# MUST be <= BACKUP_RETENTION_DAYS (need base backup to use WAL files!)
# Default: 30 days (allows recovery to any point in last month)
# Note: Can reduce to 21 days to save ~15% storage if 3-week PITR is sufficient
WAL_RETENTION_DAYS=30

#------------------------------------------------------------------------------
# POSTGRESQL CONNECTION
#------------------------------------------------------------------------------

# PostgreSQL connection settings
# Usually localhost for local PostgreSQL instance
PGHOST=localhost
PGPORT=5432
PGDATABASE=soar
PGUSER=postgres

# Password authentication:
# DO NOT set PGPASSWORD here! Instead use ~/.pgpass file:
#   echo "localhost:5432:soar:postgres:your-password" >> ~/.pgpass
#   chmod 600 ~/.pgpass
#
# Or use peer authentication (if postgres user runs the scripts)

# PostgreSQL data directory and version (for restore operations)
# Adjust based on your PostgreSQL installation
PGDATA=/var/lib/postgresql/17/main
PG_VERSION=17

#------------------------------------------------------------------------------
# BACKUP PATHS
#------------------------------------------------------------------------------

# Temporary directory for staging backups during creation
# Needs space for ~150GB compressed backup during upload
# Will be automatically created if it doesn't exist
BACKUP_TEMP_DIR=/var/lib/soar/backup-temp

# Directory for backup logs
# Will be automatically created if it doesn't exist
BACKUP_LOG_DIR=/var/log/soar

#------------------------------------------------------------------------------
# BACKUP COMPRESSION AND PERFORMANCE
#------------------------------------------------------------------------------

# Compression method for base backups
# NOTE: The backup script uses zstd compression
# This setting is kept for backward compatibility but is not currently used
# by the soar-base-backup script, which hardcodes zstd compression.
# Options: zstd (recommended), gzip, none
# zstd reduces size by ~60-70% and is faster than gzip with multi-threading
BACKUP_COMPRESSION=zstd

# Compression level for zstd (used by pg_basebackup)
# Valid range: -131072 to 22 (negative values for ultra-fast compression)
# Recommended values:
#   1  = fastest compression, larger files
#   3  = default, good balance of speed and compression (recommended)
#   9  = slower but better compression
#   19 = maximum compression, much slower
# Default: 3
BACKUP_COMPRESSION_LEVEL=3

# Number of parallel jobs for compression/upload
# NOTE: This setting is used for operations like rsync parallelization
# The zstd compression level is controlled by BACKUP_COMPRESSION_LEVEL above
# Recommended: 2-4 for most systems
BACKUP_PARALLEL_JOBS=4

#------------------------------------------------------------------------------
# MONITORING AND NOTIFICATIONS (OPTIONAL)
#------------------------------------------------------------------------------

# Email notification on backup success/failure (requires mail command)
# Leave empty to disable email notifications
BACKUP_NOTIFY_EMAIL=
# Example: BACKUP_NOTIFY_EMAIL=ops@example.com

# Slack webhook for notifications
# Create webhook at: https://api.slack.com/messaging/webhooks
# Leave empty to disable Slack notifications
BACKUP_NOTIFY_SLACK_WEBHOOK=
# Example: BACKUP_NOTIFY_SLACK_WEBHOOK=https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX

# Sentry DSN for error tracking and notifications
# The backup scripts will send events to Sentry for both successes and failures
# Sentry is already used by the SOAR application - use the same DSN
# Leave empty to disable Sentry notifications
SENTRY_DSN=
# Example: SENTRY_DSN=https://abc123def456@o123456.ingest.sentry.io/7890123
#
# Events sent to Sentry:
# - Base backup failures (level: error)
# - Base backup successes (level: info)
# - Verification failures (level: error)
# - Verification warnings (level: warning)
# - Verification successes (level: info)
#
# Each event includes:
# - Backup details (name, date, hostname)
# - Error messages and context
# - Tags for filtering (backup_type, status, environment)

# Prometheus Pushgateway for metrics (optional)
# If you have a Pushgateway, backup metrics will be pushed after each backup
METRICS_PUSHGATEWAY=
# Example: METRICS_PUSHGATEWAY=http://localhost:9091

#------------------------------------------------------------------------------
# SSH CONNECTION CONFIGURATION
#------------------------------------------------------------------------------

# Additional SSH options can be configured by modifying the backup scripts
# Default SSH options used:
#   -i $SSH_KEY                      # Use specified private key
#   -o StrictHostKeyChecking=accept-new  # Accept new host keys automatically
#   -o BatchMode=yes                 # Non-interactive mode

#------------------------------------------------------------------------------
# ADVANCED CONFIGURATION
#------------------------------------------------------------------------------

# WAL segment size (usually 16MB, don't change unless you know what you're doing)
# export WAL_SEGMENT_SIZE=16777216

# Archive timeout (seconds) - how long to wait before archiving partial WAL
# Only relevant if database is very low write volume
# export ARCHIVE_TIMEOUT=300

# Maximum retries for cloud uploads
# export MAX_UPLOAD_RETRIES=3

# Upload retry delay (seconds)
# export UPLOAD_RETRY_DELAY=60

#------------------------------------------------------------------------------
# VERIFICATION
#------------------------------------------------------------------------------

# After editing this file, verify the configuration:
#
# 1. Test SSH access to backup server:
#    source /etc/soar/backup-env
#    ssh -i ${BACKUP_SSH_KEY} ${BACKUP_SSH_USER}@${BACKUP_SSH_HOST} "ls -la ${BACKUP_SSH_PATH}"
#
# 2. Test WAL archiving (as postgres user):
#    sudo -u postgres /usr/local/bin/soar-wal-archive \
#      /var/lib/postgresql/17/main/pg_wal/000000010000000000000001 \
#      000000010000000000000001
#
# 3. Test base backup (manual run):
#    sudo systemctl start soar-backup-base.service
#    sudo journalctl -u soar-backup-base.service -f
#
# 4. Verify backup on remote server:
#    ssh -i ${BACKUP_SSH_KEY} ${BACKUP_SSH_USER}@${BACKUP_SSH_HOST} \
#      "find ${BACKUP_SSH_PATH}/base -type d"
