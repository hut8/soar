# Cross-compilation configuration for ARM64 (Raspberry Pi 4) and static musl builds
# https://github.com/cross-rs/cross

[build.env]
passthrough = [
    "RUSTFLAGS",
    "SKIP_WEB_BUILD",
]

[target.aarch64-unknown-linux-gnu]
# Use the default cross image which includes libpq for PostgreSQL
# The image provides: gcc-aarch64-linux-gnu, g++-aarch64-linux-gnu, and common libs
pre-build = [
    "dpkg --add-architecture arm64",
    # Install clang for build scripts (they compile for host and .cargo/config.toml sets linker = clang)
    "apt-get update && apt-get install -y clang libpq-dev:arm64 libssl-dev:arm64 protobuf-compiler",
]

[target.x86_64-unknown-linux-musl]
# Musl build for x86_64 - fully static binary
# We use pq-sys bundled feature to compile libpq from source, which includes all static libs
pre-build = [
    "apt-get update",
    # Build dependencies for compiling PostgreSQL and OpenSSL from source
    # build-essential: gcc, g++, make for compiling C code
    # pkg-config: for finding libraries
    # perl: required for building OpenSSL from source
    # clang: needed by some build scripts
    # zlib1g-dev: compression library
    # protobuf-compiler: for compiling .proto files
    # Use DEBIAN_FRONTEND=noninteractive to prevent prompts
    "DEBIAN_FRONTEND=noninteractive apt-get install -y -qq build-essential pkg-config perl clang zlib1g-dev protobuf-compiler",
]

[target.aarch64-unknown-linux-musl]
# Musl build for aarch64 - fully static binary
# We use pq-sys bundled feature to compile libpq from source, which includes all static libs
pre-build = [
    "dpkg --add-architecture arm64",
    "apt-get update",
    # Build dependencies for compiling PostgreSQL and OpenSSL from source
    # build-essential: gcc, g++, make for compiling C code
    # crossbuild-essential-arm64: cross-compilation toolchain
    # pkg-config: for finding libraries
    # perl: required for building OpenSSL from source
    # clang: needed by some build scripts
    # zlib1g-dev:arm64: ARM64 compression library
    # protobuf-compiler: for compiling .proto files
    # Use DEBIAN_FRONTEND=noninteractive to prevent tzdata prompts during install
    "DEBIAN_FRONTEND=noninteractive apt-get install -y -qq build-essential crossbuild-essential-arm64 pkg-config perl clang zlib1g-dev:arm64 protobuf-compiler",
]
