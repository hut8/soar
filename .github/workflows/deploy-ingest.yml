name: Deploy Ingest Services

permissions:
  contents: read

# Manual workflow for deploying ingest-* services to staging or production
# These services change infrequently and don't need to be deployed with every push

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      services:
        description: 'Services to deploy (comma-separated: ingest-ogn, ingest-adsb, or "all")'
        required: true
        default: 'all'

jobs:
  deploy-ingest:
    name: Deploy Ingest Services to ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for git tags

      - name: Parse services to deploy
        id: parse-services
        run: |
          SERVICES="${{ inputs.services }}"

          if [ "$SERVICES" = "all" ]; then
            echo "deploy_ogn=true" >> $GITHUB_OUTPUT
            echo "deploy_adsb=true" >> $GITHUB_OUTPUT
            echo "Deploying all ingest services"
          else
            # Parse comma-separated list
            if echo "$SERVICES" | grep -q "ingest-ogn"; then
              echo "deploy_ogn=true" >> $GITHUB_OUTPUT
              echo "Will deploy ingest-ogn"
            else
              echo "deploy_ogn=false" >> $GITHUB_OUTPUT
            fi

            if echo "$SERVICES" | grep -q "ingest-adsb"; then
              echo "deploy_adsb=true" >> $GITHUB_OUTPUT
              echo "Will deploy ingest-adsb"
            else
              echo "deploy_adsb=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ "${{ inputs.environment }}" = "staging" ]; then
            ssh-keyscan -H staging.glider.flights >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H glider.flights >> ~/.ssh/known_hosts
          fi

      - name: Determine target server
        id: target
        run: |
          if [ "${{ inputs.environment }}" = "staging" ]; then
            echo "server=staging.glider.flights" >> $GITHUB_OUTPUT
            echo "suffix=-staging" >> $GITHUB_OUTPUT
          else
            echo "server=glider.flights" >> $GITHUB_OUTPUT
            echo "suffix=" >> $GITHUB_OUTPUT
          fi

      - name: Stop ingest-ogn service
        if: steps.parse-services.outputs.deploy_ogn == 'true'
        run: |
          SERVER="${{ steps.target.outputs.server }}"
          SUFFIX="${{ steps.target.outputs.suffix }}"

          echo "Stopping soar-ingest-ogn${SUFFIX}.service on $SERVER..."
          ssh soar@$SERVER "sudo systemctl stop soar-ingest-ogn${SUFFIX}.service" || true

      - name: Stop ingest-adsb service
        if: steps.parse-services.outputs.deploy_adsb == 'true'
        run: |
          SERVER="${{ steps.target.outputs.server }}"
          SUFFIX="${{ steps.target.outputs.suffix }}"

          echo "Stopping soar-ingest-adsb${SUFFIX}.service on $SERVER..."
          ssh soar@$SERVER "sudo systemctl stop soar-ingest-adsb${SUFFIX}.service" || true

      - name: Install systemd service files
        run: |
          SERVER="${{ steps.target.outputs.server }}"
          SUFFIX="${{ steps.target.outputs.suffix }}"
          DEPLOY_OGN="${{ steps.parse-services.outputs.deploy_ogn }}"
          DEPLOY_ADSB="${{ steps.parse-services.outputs.deploy_adsb }}"

          # Copy service files to server's temp directory
          TEMP_DIR="/tmp/soar-ingest-deploy-$(date +%s)"
          ssh soar@$SERVER "mkdir -p $TEMP_DIR"

          if [ "$DEPLOY_OGN" = "true" ]; then
            echo "Uploading soar-ingest-ogn${SUFFIX}.service..."
            scp infrastructure/systemd/soar-ingest-ogn${SUFFIX}.service soar@$SERVER:$TEMP_DIR/
          fi

          if [ "$DEPLOY_ADSB" = "true" ]; then
            echo "Uploading soar-ingest-adsb${SUFFIX}.service..."
            scp infrastructure/systemd/soar-ingest-adsb${SUFFIX}.service soar@$SERVER:$TEMP_DIR/
          fi

          # Install service files
          ssh soar@$SERVER "sudo install -m 644 -o root -g root $TEMP_DIR/*.service /etc/systemd/system/"

          # Reload systemd
          echo "Reloading systemd daemon..."
          ssh soar@$SERVER "sudo systemctl daemon-reload"

          # Cleanup
          ssh soar@$SERVER "rm -rf $TEMP_DIR"

      - name: Enable and start ingest-ogn service
        if: steps.parse-services.outputs.deploy_ogn == 'true'
        run: |
          SERVER="${{ steps.target.outputs.server }}"
          SUFFIX="${{ steps.target.outputs.suffix }}"

          echo "Enabling soar-ingest-ogn${SUFFIX}.service..."
          ssh soar@$SERVER "sudo systemctl enable soar-ingest-ogn${SUFFIX}.service"

          echo "Starting soar-ingest-ogn${SUFFIX}.service..."
          ssh soar@$SERVER "sudo systemctl start soar-ingest-ogn${SUFFIX}.service"

          # Wait for service to start
          sleep 3

          # Check status
          echo "Service status:"
          ssh soar@$SERVER "sudo systemctl status soar-ingest-ogn${SUFFIX}.service --no-pager" || true

      - name: Enable and start ingest-adsb service
        if: steps.parse-services.outputs.deploy_adsb == 'true'
        run: |
          SERVER="${{ steps.target.outputs.server }}"
          SUFFIX="${{ steps.target.outputs.suffix }}"

          echo "Enabling soar-ingest-adsb${SUFFIX}.service..."
          ssh soar@$SERVER "sudo systemctl enable soar-ingest-adsb${SUFFIX}.service"

          echo "Starting soar-ingest-adsb${SUFFIX}.service..."
          ssh soar@$SERVER "sudo systemctl start soar-ingest-adsb${SUFFIX}.service"

          # Wait for service to start
          sleep 3

          # Check status
          echo "Service status:"
          ssh soar@$SERVER "sudo systemctl status soar-ingest-adsb${SUFFIX}.service --no-pager" || true

      - name: Verify deployment
        run: |
          SERVER="${{ steps.target.outputs.server }}"
          SUFFIX="${{ steps.target.outputs.suffix }}"
          DEPLOY_OGN="${{ steps.parse-services.outputs.deploy_ogn }}"
          DEPLOY_ADSB="${{ steps.parse-services.outputs.deploy_adsb }}"

          ALL_HEALTHY=true

          if [ "$DEPLOY_OGN" = "true" ]; then
            if ssh soar@$SERVER "systemctl is-active --quiet soar-ingest-ogn${SUFFIX}.service"; then
              echo "✓ soar-ingest-ogn${SUFFIX}.service is active"
            else
              echo "✗ soar-ingest-ogn${SUFFIX}.service failed to start"
              ALL_HEALTHY=false
            fi
          fi

          if [ "$DEPLOY_ADSB" = "true" ]; then
            if ssh soar@$SERVER "systemctl is-active --quiet soar-ingest-adsb${SUFFIX}.service"; then
              echo "✓ soar-ingest-adsb${SUFFIX}.service is active"
            else
              echo "✗ soar-ingest-adsb${SUFFIX}.service failed to start"
              ALL_HEALTHY=false
            fi
          fi

          if [ "$ALL_HEALTHY" = "false" ]; then
            echo "Deployment verification failed!"
            exit 1
          fi

          echo "All deployed services are healthy!"

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
