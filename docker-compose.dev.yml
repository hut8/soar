# Development compose file with source mounting and build caching
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # Override soar service for development
  soar:
    # Use a base Rust image instead of building
    image: rust:1-slim-bookworm
    # Mount source code for live editing
    volumes:
      - .:/workspace
      # Cache Rust build artifacts between runs
      - cargo-cache:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target-cache:/workspace/target
    working_dir: /workspace
    # Environment variables are inherited from base docker-compose.yml automatically
    # No need to redeclare them here
    # Override health check for dev mode - first compile takes up to 10 minutes
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:61226/"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 600s  # 10 minutes for initial compile
    # Install build dependencies and compile on startup
    command: >
      sh -c "
        echo 'Installing build dependencies...' &&
        apt-get update > /dev/null 2>&1 &&
        apt-get install -y --no-install-recommends clang build-essential pkg-config libssl-dev libpq-dev curl > /dev/null 2>&1 &&
        echo 'Building application (using cached artifacts)...' &&
        SKIP_WEB_BUILD=1 cargo build --release &&
        echo 'Running migrations...' &&
        ./target/release/soar migrate &&
        echo 'Seeding test data...' &&
        ./target/release/soar seed-test-data &&
        echo 'Starting web server...' &&
        ./target/release/soar web --port 61226 --interface 0.0.0.0 --test-mode
      "

volumes:
  # Persist Rust build cache
  cargo-cache:
    driver: local
  cargo-git:
    driver: local
  target-cache:
    driver: local
